{"version":3,"names":["DEFAULT_AVATAR","myPhoneNumber","common_vendor","ref","chatList","isLoading","onLoad","userInfo","index","getStorageSync","phoneNumber","value","showToast","title","icon","onShow","fetchChatList","fetchTotalUnreadCount","_ref","_asyncToGenerator2","_regeneratorRuntime2","mark","_callee","res","totalUnread","wrap","_callee$","_context","prev","next","abrupt","nr","callFunction","name","data","userPhoneNumber","sent","result","success","__f__","concat","setTabBarBadge","text","toString","removeTabBarBadge","t0","stop","_x","apply","arguments","getAvatarSrc","item","src","avatar","Date","now","goToChatDetail","sessionId","navigateTo","url","formatTime","timestamp","date","todayStart","getFullYear","getMonth","getDate","yesterdayStart","getTime","getHours","padStart","getMinutes","handleAvatarError","findIndex","i","wx","createPage","MiniProgramPage"],"sources":["chatList.vue","cGFnZXMvY2hhdExpc3QvY2hhdExpc3QudnVl"],"sourcesContent":["<template>\n\t<view class=\"header-emptybox\">\n\t\t<text class=\"profile-title\">消息</text>\n\t</view>\n\t<view class=\"chat-list-page\">\n\t\t<view v-if=\"isLoading\" class=\"skeleton-container\">\n\t\t\t<view v-for=\"i in 3\" :key=\"i\" class=\"skeleton-item\">\n\t\t\t\t<view class=\"skeleton-avatar\"></view>\n\t\t\t\t<view class=\"skeleton-details\">\n\t\t\t\t\t<view class=\"skeleton-line-long\"></view>\n\t\t\t\t\t<view class=\"skeleton-line-short\"></view>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t</view>\n\n\t\t<view class=\"chat-list\" v-else-if=\"chatList.length > 0\">\n\t\t\t<view\n\t\t\t\tv-for=\"item in chatList\"\n\t\t\t\t:key=\"item.sessionId\"\n\t\t\t\tclass=\"chat-item\"\n\t\t\t\t@click=\"goToChatDetail(item.sessionId)\"\n\t\t\t>\n\t\t\t\t<image\n\t\t\t\t\tclass=\"avatar\"\n\t\t\t\t\t:src=\"getAvatarSrc(item)\"  mode=\"aspectFill\"\n\t\t\t\t\t@error=\"handleAvatarError(item)\"\n\t\t\t\t/>\n\t\t\t\t<view class=\"chat-details\">\n\t\t\t\t\t<view class=\"header\">\n\t\t\t\t\t\t<text class=\"nickname\">{{ item.name }}</text>\n\t\t\t\t\t\t<text class=\"last-time\">{{ formatTime(item.lastTime) }}</text>\n\t\t\t\t\t</view>\n\t\t\t\t\t<view class=\"footer\">\n\t\t\t\t\t\t<text class=\"last-message\">{{ item.lastMessage }}</text>\n\t\t\t\t\t\t<view class=\"badge\" v-if=\"item.unread > 0\">\n\t\t\t\t\t\t\t<text class=\"badge-text\">{{ item.unread > 99 ? '99+' : item.unread }}</text>\n\t\t\t\t\t\t</view>\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t</view>\n\n\t\t<view v-else class=\"empty-state\">\n\t\t\t<image src=\"/static/images/empty-chat.png\" class=\"empty-icon\" mode=\"widthFix\" />\n\t\t\t<text class=\"empty-text\">暂无会话消息</text>\n\t\t\t<text class=\"empty-tip\">去和工人们打招呼吧</text>\n\t\t</view>\n\t</view>\n</template>\n\n\n// pages/chatList/chatList.vue\n// chatList.vue\n<script setup>\nimport { ref } from 'vue';\nimport { onLoad, onShow } from '@dcloudio/uni-app';\n\n// --- 响应式状态 (State) ---\nconst myPhoneNumber = ref('');\nconst chatList = ref([]);\nconst isLoading = ref(true);\nconst DEFAULT_AVATAR = '/static/images/avatar-placeholder.png';\n\n// --- 页面生命周期 (Lifecycle) ---\nonLoad(() => {\n    const userInfo = uni.getStorageSync('userinfo');\n    if (!userInfo || !userInfo.phoneNumber) {\n        isLoading.value = false;\n        uni.showToast({ title: '请先登录', icon: 'none' });\n        return;\n    }\n    myPhoneNumber.value = userInfo.phoneNumber;\n});\n\nonShow(() => {\n    if (myPhoneNumber.value) {\n        fetchChatList();\n        fetchTotalUnreadCount(myPhoneNumber.value); // 每次显示时刷新 TabBar 角标\n    }\n});\n\n// --- 方法 (Methods) ---\nconst fetchフォンList = async () => {\n    if (!myPhoneNumber.value) {\n        isLoading.value = false;\n        return;\n    }\n    \n    isLoading.value = true;\n    try {\n        const res = await uniCloud.callFunction({\n            name: 'get-chat-list',\n            data: {\n                userPhoneNumber: myPhoneNumber.value\n            }\n        });\n\n        if (res.result.success) {\n            chatList.value = res.result.data.map(session => ({\n                ...session,\n                unread: session.unreadCount || 0\n            }));\n        } else {\n            console.error('获取会话列表失败:', res.result.msg);\n        }\n    } catch (error) {\n        console.error('请求会话列表时出错:', error);\n    } finally {\n        isLoading.value = false;\n    }\n};\n\nconst fetchTotalUnreadCount = async (phoneNumber) => {\n    if (!phoneNumber) return;\n\n    try {\n        const res = await uniCloud.callFunction({\n            name: 'get-total-unread-count',\n            data: { userPhoneNumber: phoneNumber }\n        });\n\n        if (res.result.success) {\n            const totalUnread = res.result.totalUnread || 0;\n            console.log(`[chatList] Fetched total unread count for ${phoneNumber}: ${totalUnread}`);\n            if (totalUnread > 0) {\n                uni.setTabBarBadge({\n                    index: 2,\n                    text: totalUnread > 99 ? '99+' : totalUnread.toString()\n                });\n            } else {\n                uni.removeTabBarBadge({ index: 2 });\n            }\n        }\n    } catch (error) {\n        console.error('[chatList] Failed to fetch total unread count:', error);\n    }\n};\n\nconst getAvatarSrc = (item) => {\n    const src = item.avatar || DEFAULT_AVATAR;\n    return `${src}?_t=${Date.now()}`;\n};\n\nconst goToChatDetail = (sessionId) => {\n    uni.navigateTo({\n        url: `/pages/chatDetail/chatDetail?sessionId=${sessionId}`\n    });\n};\n\nconst formatTime = (timestamp) => {\n    if (!timestamp) return '';\n    const date = new Date(timestamp);\n    const now = new Date();\n    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n    const yesterdayStart = new Date(todayStart.getTime() - 24 * 60 * 60 * 1000);\n\n    if (date.getTime() > todayStart.getTime()) {\n        return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;\n    } else if (date.getTime() > yesterdayStart.getTime()) {\n        return '昨天';\n    } else {\n        return `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;\n    }\n};\n\nconst handleAvatarError = (item) => {\n    const index = chatList.value.findIndex((i) => i.sessionId === item.sessionId);\n    if (index > -1) {\n        chatList.value[index].avatar = null;\n    }\n};\n</script>\n\n<style lang=\"scss\" scoped>\n/* 样式保持不变 */\n.header-emptybox {\n\twidth: 100%;\n\theight: 230rpx;\n\tposition: relative;\n}\n.profile-title {\n\tposition: absolute;\n\tfont-size: 55rpx;\n\tfont-weight: 580;\n\tcolor: #1c1c1e;\n\tfont-family: \"Helvetica Neue\", \"PingFang SC\", \"Helvetica\", \"Arial\", sans-serif;\n\ttop: 130rpx;\n\tleft: 35rpx;\n}\n\n.chat-list-page {\n\tbackground-color: #ffffff;\n\tmin-height: 100vh;\n}\n\n.chat-list {\n\tpadding: 0 30rpx;\n}\n\n.chat-item {\n\tdisplay: flex;\n\talign-items: center;\n\tpadding: 30rpx 0;\n\tborder-bottom: 1rpx solid #f0f0f0;\n\ttransition: background-color 0.2s;\n\t&:last-child {\n\t\tborder-bottom: none;\n\t}\n\t&:active {\n\t\tbackground-color: #f5f5f5;\n\t}\n}\n\n.avatar {\n\twidth: 100rpx;\n\theight: 100rpx;\n\tborder-radius: 50%;\n\tmargin-right: 24rpx;\n\tflex-shrink: 0;\n\tbackground-color: #eee;\n}\n\n.chat-details {\n\tflex: 1;\n\tdisplay: flex;\n\tflex-direction: column;\n\tjustify-content: center;\n\toverflow: hidden;\n}\n\n.header {\n\tdisplay: flex;\n\tjustify-content: space-between;\n\talign-items: center;\n\tmargin-bottom: 8rpx;\n}\n\n.nickname {\n\tfont-size: 32rpx;\n\tcolor: #333;\n\tfont-weight: 500;\n}\n\n.last-time {\n\tfont-size: 24rpx;\n\tcolor: #999;\n\tflex-shrink: 0;\n}\n\n.footer {\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: space-between;\n\tgap: 16rpx;\n}\n\n.last-message {\n\tflex: 1;\n\tfont-size: 28rpx;\n\tcolor: #888;\n\toverflow: hidden;\n\ttext-overflow: ellipsis;\n\twhite-space: nowrap;\n}\n\n.badge {\n\tbackground-color: #fa3534;\n\tborder-radius: 999rpx;\n\tdisplay: inline-flex;\n\talign-items: center;\n\tjustify-content: center;\n\tpadding: 0 12rpx;\n\theight: 36rpx;\n\tmin-width: 36rpx;\n\tflex-shrink: 0;\n\tbox-sizing: border-box;\n\tanimation: pulse 1.5s infinite;\n\tbox-shadow: 0 4rpx 8rpx rgba(250, 53, 52, 0.3);\n\tmargin-bottom: 5rpx;\n}\n\n.badge-text {\n\tfont-size: 24rpx;\n\tcolor: #ffffff;\n\tfont-weight: bold;\n\tline-height: 1;\n}\n\n.empty-state {\n\tdisplay: flex;\n\tflex-direction: column;\n\talign-items: center;\n\tjustify-content: center;\n\tpadding-top: 280rpx;\n\t.empty-icon {\n\t\twidth: 300rpx;\n\t}\n\t.empty-text {\n\t\tfont-size: 30rpx;\n\t\tcolor: #333;\n\t\tmargin-top: 30rpx;\n\t}\n\t.empty-tip {\n\t\tfont-size: 26rpx;\n\t\tcolor: #999;\n\t\tmargin-top: 15rpx;\n\t}\n}\n\n.skeleton-container {\n\tpadding: 0 30rpx;\n}\n.skeleton-item {\n\tdisplay: flex;\n\talign-items: center;\n\tpadding: 40rpx 0;\n\tborder-bottom: 1rpx solid #f0f0f0;\n}\n.skeleton-avatar {\n\twidth: 120rpx;\n\theight: 120rpx;\n\tborder-radius: 50%;\n\tbackground-color: #E0E0E0;\n\tmargin-right: 24rpx;\n\tanimation: skeleton-shimmer 1.5s infinite ease-in-out;\n}\n.skeleton-details {\n\tflex: 1;\n\tdisplay: flex;\n\tflex-direction: column;\n\tjustify-content: space-around;\n\theight: 100rpx;\n}\n.skeleton-line-long {\n\twidth: 80%;\n\theight: 36rpx;\n\tbackground-color: #E0E0E0;\n\tborder-radius: 8rpx;\n\tanimation: skeleton-shimmer 1.5s infinite ease-in-out;\n}\n.skeleton-line-short {\n\twidth: 50%;\n\theight: 28rpx;\n\tbackground-color: #E0E0E0;\n\tborder-radius: 8rpx;\n\tanimation: skeleton-shimmer 1.5s infinite ease-in-out;\n}\n\n@keyframes skeleton-shimmer {\n\t0% {\n\t\topacity: 0.5;\n\t}\n\t50% {\n\t\topacity: 1;\n\t}\n\t100% {\n\t\topacity: 0.5;\n\t}\n}\n</style>","import MiniProgramPage from 'D:/peng的文件/fengdian-main/fengdian-main/pages/chatList/chatList.vue'\nwx.createPage(MiniProgramPage)"],"mappings":"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","ignoreList":[]}