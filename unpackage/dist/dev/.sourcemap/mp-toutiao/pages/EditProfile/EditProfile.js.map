{"version":3,"file":"EditProfile.js","sources":["pages/EditProfile/EditProfile.vue","../../../HBuilderX.4.66.2025051912/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvRWRpdFByb2ZpbGUvRWRpdFByb2ZpbGUudnVl"],"sourcesContent":["<template>\n  <view class=\"container\">\n    <!-- 头像区域（点击更换） -->\n    <view class=\"avatar-edit\" @click=\"chooseAvatar\">\n      <image\n        class=\"avatar\"\n        :src=\"avatarTemp || avatarOld || '/static/images/default-avatar.png'\"\n        mode=\"aspectFill\"\n      />\n    </view>\n    <text class=\"tip\">点击更换头像</text>\n\n    <!-- 姓名输入 -->\n    <view class=\"field\">\n      <text class=\"label\">姓名：</text>\n      <input\n        class=\"input\"\n        placeholder=\"请输入您的姓名\"\n        v-model=\"name\"\n      />\n    </view>\n\n    <!-- 工人专属：收款信息修改区域 -->\n    <template v-if=\"isWorker\">\n      <view class=\"section-title\">收款信息</view>\n      <text class=\"section-tip\">请确保收款信息准确无误，以便正常提现。</text>\n\n      <!-- 微信号 -->\n      <view class=\"field\">\n        <text class=\"label\">微信号：</text>\n        <input\n          class=\"input\"\n          placeholder=\"请输入您的微信号 (可选)\"\n          v-model=\"weChatId\"\n        />\n      </view>\n\n      <!-- 微信收款码 -->\n      <view class=\"field\">\n        <text class=\"label required-label\">收款码：</text>\n        <view class=\"qr-code-uploader\">\n          <view v-if=\"weChatQrCodeTemp || weChatQrCodeUrlOld\" class=\"image-preview\">\n            <image\n              :src=\"weChatQrCodeTemp || weChatQrCodeUrlOld\"\n              mode=\"aspectFill\"\n              class=\"uploaded-image\"\n            />\n            <view class=\"delete-btn\" @click=\"removeQrCode\">×</view>\n          </view>\n          <view v-else class=\"upload-btn\" @click=\"chooseQrCode\">\n            <text>+</text>\n          </view>\n        </view>\n        <text class=\"tip\">点击上传或更换收款码图片</text>\n        <text v-if=\"isUploadingQrCode\" class=\"uploading-tip\">收款码上传中...</text>\n      </view>\n    </template>\n\n    <!-- 保存按钮 -->\n    <button class=\"save-btn\" @click=\"submitProfile\" :loading=\"isLoading || isUploadingQrCode\">保存修改</button>\n  </view>\n</template>\n\n<script setup>\nimport { ref, onMounted } from 'vue'\n\n// 响应式数据\nconst name = ref('')\nconst avatarOld = ref('')       // 原有头像 fileID\nconst avatarTemp = ref('')      // 本地临时路径\nconst avatarNewFileID = ref('') // 上传后的 fileID\nconst isLoading = ref(false); // 保存按钮的加载状态\n\n// 工人专属数据\nconst isWorker = ref(false); // 是否是已认证的工人\nconst weChatId = ref('');\nconst weChatQrCodeUrlOld = ref('');       // 原有收款码 URL\nconst weChatQrCodeTemp = ref('');         // 本地临时路径\nconst weChatQrCodeNewFileID = ref('');    // 上传后的收款码 fileID\nconst isUploadingQrCode = ref(false);     // 收款码上传加载状态\n\n// 页面加载时从本地读取 userinfo 并尝试更新\nonMounted(async () => {\n  let user = uni.getStorageSync('userinfo') || {};\n  console.log('EditProfile - onMounted: 初始本地 userinfo:', user);\n\n  // 如果本地有用户ID，尝试从云端获取最新数据\n  if (user._id) {\n    try {\n      const { result } = await uniCloud.callFunction({\n        name: 'getUserInfoById', // 调用新的云函数\n        data: { userId: user._id }\n      });\n\n      if (result.success && result.data) {\n        user = result.data; // 使用云端最新数据\n        uni.setStorageSync('userinfo', user); // 更新本地缓存\n        console.log('EditProfile - onMounted: 已从云端获取最新 userinfo 并更新本地缓存:', user);\n      } else {\n        console.warn('EditProfile - onMounted: 从云端获取用户数据失败:', result.message);\n        // 如果获取失败，继续使用本地旧数据\n      }\n    } catch (err) {\n      console.error('EditProfile - onMounted: 调用 getUserInfoById 云函数异常:', err);\n      // 如果调用异常，继续使用本地旧数据\n    }\n  }\n\n  // 使用最新（或本地旧）的 user 对象来初始化页面数据\n  name.value = user.name || '';\n  avatarOld.value = user.avatar || '';\n\n  // 检查是否为已认证的工人\n  if (user.userType === 'worker' && user.technicianApplicationStatus === 'approved') {\n    isWorker.value = true;\n    weChatId.value = user.technicianInfo?.weChatId || '';\n    weChatQrCodeUrlOld.value = user.technicianInfo?.weChatQrCodeUrl || '';\n  } else {\n    isWorker.value = false;\n  }\n});\n\n// 选择新头像\nfunction chooseAvatar() {\n  uni.chooseImage({\n    count: 1,\n    sizeType: ['compressed'],\n    sourceType: ['album', 'camera'],\n    success: res => {\n      avatarTemp.value = res.tempFilePaths[0];\n      avatarNewFileID.value = ''; // Reset newFileID until uploaded\n    },\n    fail: (err) => {\n      console.error('选择头像失败:', err);\n      uni.showToast({ title: '选择头像失败', icon: 'none' });\n    }\n  })\n}\n\n// 选择微信收款码\nasync function chooseQrCode() {\n  uni.chooseImage({\n    count: 1,\n    sizeType: ['compressed'],\n    sourceType: ['album', 'camera'],\n    success: res => {\n      weChatQrCodeTemp.value = res.tempFilePaths[0];\n      weChatQrCodeNewFileID.value = ''; // Reset newFileID until uploaded\n    },\n    fail: (err) => {\n      console.error('选择收款码失败:', err);\n      uni.showToast({ title: '选择收款码失败', icon: 'none' });\n    }\n  });\n}\n\n// 移除微信收款码\nfunction removeQrCode() {\n  weChatQrCodeTemp.value = '';\n  weChatQrCodeNewFileID.value = '';\n  weChatQrCodeUrlOld.value = ''; // Clear old URL as well if removed\n}\n\n\n// 提交更新\nasync function submitProfile() {\n  // 验证姓名\n  if (!name.value.trim()) {\n    return uni.showToast({ title: '姓名不能为空', icon: 'none' })\n  }\n\n  // 如果是工人，校验收款码是否已上传\n  if (isWorker.value && !weChatQrCodeTemp.value && !weChatQrCodeUrlOld.value) {\n    return uni.showToast({ title: '请上传微信收款码', icon: 'none' });\n  }\n\n  const userInfo = uni.getStorageSync('userinfo') || {}\n  const phoneNumber = userInfo.phoneNumber\n  if (!phoneNumber) {\n    return uni.showToast({ title: '缺少用户标识符', icon: 'none' })\n  }\n\n  isLoading.value = true;\n  uni.showLoading({ title: '保存中...' })\n\n  try {\n    // 1. 上传新头像（如有）\n    if (avatarTemp.value) {\n      const cloudPath = `User-Avatar/${Date.now()}.jpg`\n      const uploadRes = await uniCloud.uploadFile({\n        cloudPath,\n        filePath: avatarTemp.value\n      })\n      if (!uploadRes.fileID) {\n        throw new Error('头像上传失败')\n      }\n      avatarNewFileID.value = uploadRes.fileID\n    }\n\n    // 2. 上传新收款码（如果用户是工人且选择了新收款码）\n    if (isWorker.value && weChatQrCodeTemp.value) {\n      isUploadingQrCode.value = true;\n      const cloudPathQr = `Worker-QrCodes/${userInfo._id}_${Date.now()}.png`; // Unique path for QR codes\n      const uploadQrRes = await uniCloud.uploadFile({\n        cloudPath: cloudPathQr,\n        filePath: weChatQrCodeTemp.value\n      });\n      if (!uploadQrRes.fileID) {\n        throw new Error('收款码上传失败');\n      }\n      weChatQrCodeNewFileID.value = uploadQrRes.fileID;\n      isUploadingQrCode.value = false;\n    }\n\n    // 3. 准备发送给云函数的数据\n    const dataToSend = {\n      phoneNumber,\n      name: name.value,\n      avatar: avatarNewFileID.value || '', // 新头像 ID 或空字符串\n      oldAvatarFileID: avatarOld.value || '', // 旧头像 ID，用于云端删除\n\n      // 工人专属数据\n      isWorker: isWorker.value, // 告诉云函数是否是工人\n      weChatId: isWorker.value ? weChatId.value : '', // 仅工人身份时发送微信号\n      weChatQrCodeUrl: isWorker.value ? (weChatQrCodeNewFileID.value || weChatQrCodeUrlOld.value || '') : '', // 新收款码 ID，或旧的，或空\n      oldWeChatQrCodeUrl: isWorker.value ? weChatQrCodeUrlOld.value : '' // 旧收款码 ID，用于云端删除\n    };\n\n    // 4. 调用云函数更新用户信息\n    const { result } = await uniCloud.callFunction({\n      name: 'updateUserProfile', // 这个云函数需要被更新以处理工人信息\n      data: dataToSend\n    })\n    if (result.code !== 200 || !result.success) {\n      throw new Error(result.msg || '云函数返回错误')\n    }\n\n    // 5. 更新本地缓存\n    uni.setStorageSync('userinfo', result.data)\n\n    uni.hideLoading()\n    uni.showToast({ title: '更新成功', icon: 'success' })\n    setTimeout(() => uni.navigateBack(), 800)\n\n  } catch (err) {\n    console.error('更新过程出错:', err)\n    uni.hideLoading()\n    isLoading.value = false; // 确保加载状态被重置\n    isUploadingQrCode.value = false; // 确保加载状态被重置\n    uni.showToast({ title: err.message || '更新失败，请重试', icon: 'none' })\n  }\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.container {\n  padding: 40rpx;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n}\n\n.avatar-edit {\n  width: 200rpx;\n  height: 200rpx;\n  border-radius: 50%;\n  overflow: hidden;\n  border: 4rpx solid var(--themeColor, #007aff); /* 默认主题色 */\n  background: #fff;\n  margin-bottom: 20rpx;\n}\n.avatar {\n  width: 100%;\n  height: 100%;\n}\n\n.tip {\n  font-size: 24rpx;\n  color: #888;\n  margin-bottom: 40rpx;\n}\n\n.field {\n  width: 100%;\n  margin-bottom: 30rpx;\n  display: flex;\n  align-items: center;\n}\n.label {\n  font-size: 32rpx;\n  width: 160rpx; /* 调整标签宽度 */\n  flex-shrink: 0;\n  color: #333;\n}\n.input {\n  flex: 1;\n  height: 64rpx;\n  font-size: 28rpx;\n  border-bottom: 2rpx solid #eee; /* 更柔和的底部边框 */\n  padding: 0 10rpx;\n}\n\n.section-title {\n  width: 100%;\n  font-size: 36rpx;\n  font-weight: bold;\n  color: #333;\n  margin-top: 60rpx;\n  margin-bottom: 10rpx;\n  padding-bottom: 10rpx;\n  border-bottom: 1rpx solid #eee;\n  text-align: left;\n}\n.section-tip {\n  width: 100%;\n  font-size: 26rpx;\n  color: #666;\n  margin-bottom: 30rpx;\n  display: block;\n  text-align: left;\n}\n\n.required-label::after {\n  content: '*';\n  color: #ff3b30; /* 红色星号 */\n  margin-left: 8rpx;\n}\n\n.qr-code-uploader {\n  flex: 1;\n  display: flex;\n  justify-content: flex-start; /* 左对齐 */\n  align-items: center;\n  margin-top: 10rpx;\n}\n.qr-code-uploader .image-preview {\n  position: relative;\n  width: 200rpx;\n  height: 200rpx;\n  border-radius: 10rpx;\n  overflow: hidden;\n  border: 1rpx solid #eee;\n}\n.qr-code-uploader .uploaded-image {\n  width: 100%;\n  height: 100%;\n  object-fit: cover;\n}\n.qr-code-uploader .delete-btn {\n  position: absolute;\n  top: 0;\n  right: 0;\n  background-color: rgba(0, 0, 0, 0.5);\n  color: #fff;\n  width: 40rpx;\n  height: 40rpx;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  border-bottom-left-radius: 10rpx;\n  font-size: 28rpx;\n  z-index: 1;\n}\n.qr-code-uploader .upload-btn {\n  width: 200rpx;\n  height: 200rpx;\n  border: 2rpx dashed #ccc;\n  border-radius: 10rpx;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 80rpx; /* 更大的加号 */\n  color: #ccc;\n  background-color: #f9f9f9;\n  &:active {\n    border-color: #007aff;\n    color: #007aff;\n  }\n}\n.uploading-tip {\n  font-size: 24rpx;\n  color: #888;\n  margin-top: 10rpx;\n  margin-left: 20rpx;\n}\n\n.save-btn {\n  width: 100%;\n  height: 90rpx;\n  line-height: 90rpx;\n  text-align: center;\n  font-size: 32rpx;\n  color: #fff;\n  background: linear-gradient(135deg, #1989fa, #4db8ff);\n  border: none;\n  border-radius: 50rpx;\n  margin-top: 60rpx; /* 增加与上方内容的间距 */\n}\n</style>\n","import MiniProgramPage from 'D:/peng.folder/fengdian-main/fengdian-main/pages/EditProfile/EditProfile.vue'\ntt.createPage(MiniProgramPage)"],"names":["ref","onMounted","uni","uniCloud"],"mappings":"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"}