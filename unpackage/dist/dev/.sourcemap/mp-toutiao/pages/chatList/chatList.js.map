{"version":3,"file":"chatList.js","sources":["pages/chatList/chatList.vue","../../../HBuilderX.4.66.2025051912/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY2hhdExpc3QvY2hhdExpc3QudnVl"],"sourcesContent":["<template>\n\t<view class=\"header-emptybox\">\n\t\t<text class=\"profile-title\">消息</text>\n\t</view>\n\t<view class=\"chat-list-page\">\n\t\t<view v-if=\"isLoading\" class=\"skeleton-container\">\n\t\t\t<view v-for=\"i in 3\" :key=\"i\" class=\"skeleton-item\">\n\t\t\t\t<view class=\"skeleton-avatar\"></view>\n\t\t\t\t<view class=\"skeleton-details\">\n\t\t\t\t\t<view class=\"skeleton-line-long\"></view>\n\t\t\t\t\t<view class=\"skeleton-line-short\"></view>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t</view>\n\n\t\t<view class=\"chat-list\" v-else-if=\"chatList.length > 0\">\n\t\t\t<view\n\t\t\t\tv-for=\"item in chatList\"\n\t\t\t\t:key=\"item.sessionId\"\n\t\t\t\tclass=\"chat-item\"\n\t\t\t\t@click=\"goToChatDetail(item.sessionId)\"\n\t\t\t>\n\t\t\t\t<image\n\t\t\t\t\tclass=\"avatar\"\n\t\t\t\t\t:src=\"getAvatarSrc(item)\"  mode=\"aspectFill\"\n\t\t\t\t\t@error=\"handleAvatarError(item)\"\n\t\t\t\t/>\n\t\t\t\t<view class=\"chat-details\">\n\t\t\t\t\t<view class=\"header\">\n\t\t\t\t\t\t<text class=\"nickname\">{{ item.name }}</text>\n\t\t\t\t\t\t<text class=\"last-time\">{{ formatTime(item.lastTime) }}</text>\n\t\t\t\t\t</view>\n\t\t\t\t\t<view class=\"footer\">\n\t\t\t\t\t\t<text class=\"last-message\">{{ item.lastMessage }}</text>\n\t\t\t\t\t\t<view class=\"badge\" v-if=\"item.unread > 0\">\n\t\t\t\t\t\t\t<text class=\"badge-text\">{{ item.unread > 99 ? '99+' : item.unread }}</text>\n\t\t\t\t\t\t</view>\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t</view>\n\n\t\t<view v-else class=\"empty-state\">\n\t\t\t<image src=\"/static/images/empty-chat.png\" class=\"empty-icon\" mode=\"widthFix\" />\n\t\t\t<text class=\"empty-text\">暂无会话消息</text>\n\t\t\t<text class=\"empty-tip\">去和工人们打招呼吧</text>\n\t\t</view>\n\t</view>\n</template>\n\n\n// pages/chatList/chatList.vue\n// chatList.vue\n<script setup>\nimport { ref } from 'vue';\nimport {\n  onLoad,\n  onShow,\n  onHide,\n  onUnload\n} from '@dcloudio/uni-app';\n\nconst myPhoneNumber = ref('');\nconst chatList = ref([]);\nconst isLoading = ref(true);\nconst isFirstLoad = ref(true); // 新增：标记是否首次加载\nconst DEFAULT_AVATAR = '/static/images/avatar-placeholder.png';\n\nlet pollingTimer = null; // 全局轮询定时器\n\n// --- 生命周期钩子 ---\nonLoad(() => {\n  const ui = uni.getStorageSync('userinfo');\n  if (!ui?.phoneNumber) {\n    isLoading.value = false;\n    uni.showToast({ title: '请先登录', icon: 'none' });\n    return;\n  }\n  myPhoneNumber.value = ui.phoneNumber;\n});\n\nonShow(() => {\n  if (!myPhoneNumber.value) return;\n\n  if (isFirstLoad.value) {\n    // 首次加载，显示骨架屏\n    isLoading.value = true;\n    fetchChatList().then(() => {\n      isLoading.value = false;\n      isFirstLoad.value = false; // 加载完成后标记为非首次\n    });\n    fetchTotalUnreadCount();\n  } else {\n    // 轮询更新，不显示骨架屏\n    fetchChatList();\n    fetchTotalUnreadCount();\n  }\n\n  // 30秒轮询一次\n  if (pollingTimer) clearInterval(pollingTimer);\n  pollingTimer = setInterval(() => {\n    fetchChatList();\n    fetchTotalUnreadCount();\n  }, 20000);\n});\n\nonHide(() => {\n  if (pollingTimer) {\n    clearInterval(pollingTimer);\n    pollingTimer = null;\n  }\n});\n\nonUnload(() => {\n  if (pollingTimer) {\n    clearInterval(pollingTimer);\n    pollingTimer = null;\n  }\n});\n\nconst fetchChatList = async () => {\n  if (!myPhoneNumber.value) return;\n\n  try {\n    const res = await uniCloud.callFunction({\n      name: 'get-chat-list',\n      data: { userPhoneNumber: myPhoneNumber.value }\n    });\n    if (res.result.success) {\n      const newData = res.result.data.map(session => ({\n        ...session,\n        unread: session.unreadCount || 0\n      }));\n      // 增量更新 chatList\n      newData.forEach(newItem => {\n        const index = chatList.value.findIndex(item => item.sessionId === newItem.sessionId);\n        if (index !== -1) {\n          // 更新已有项\n          chatList.value[index] = newItem;\n        } else {\n          // 添加新项\n          chatList.value.push(newItem);\n        }\n      });\n      // 删除不存在的项\n      chatList.value = chatList.value.filter(item =>\n        newData.some(newItem => newItem.sessionId === item.sessionId)\n      );\n    }\n  } catch (e) {\n    console.error('获取会话列表失败:', e);\n  }\n};\n\nconst fetchTotalUnreadCount = async () => {\n  try {\n    const res = await uniCloud.callFunction({\n      name: 'get-total-unread-count',\n      data: { userPhoneNumber: myPhoneNumber.value }\n    });\n    if (res.result.success) {\n      const total = res.result.totalUnread || 0;\n      if (total > 0) {\n        uni.setTabBarBadge({\n          index: 2,\n          text: total > 99 ? '99+' : total.toString()\n        });\n      } else {\n        uni.removeTabBarBadge({ index: 2 });\n      }\n    }\n  } catch (e) {\n    console.error('获取总未读数失败:', e);\n  }\n};\n\n// 优化 getAvatarSrc 函数\nconst getAvatarSrc = (item) => {\n    // 优先使用后端返回的头像URL\n    // 如果没有或为空，则使用默认占位符\n    return item.avatar || DEFAULT_AVATAR;\n};\n\nconst goToChatDetail = sessionId => {\n  uni.navigateTo({\n    url: `/pages/chatDetail/chatDetail?sessionId=${sessionId}`\n  });\n};\n\nconst formatTime = timestamp => {\n  if (!timestamp) return '';\n  const date = new Date(timestamp);\n  const now = new Date();\n  const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n  const startOfYesterday = new Date(startOfToday.getTime() - 86400000);\n\n  if (date >= startOfToday) {\n    return date.toTimeString().slice(0, 5);\n  } else if (date >= startOfYesterday) {\n    return '昨天';\n  } else {\n    const m = String(date.getMonth() + 1).padStart(2, '0');\n    const d = String(date.getDate()).padStart(2, '0');\n    return `${date.getFullYear()}/${m}/${d}`;\n  }\n};\n</script>\n\n<style lang=\"scss\" scoped>\n/* 样式保持不变 */\n.header-emptybox {\n\twidth: 100%;\n\theight: 230rpx;\n\tposition: relative;\n}\n.profile-title {\n\tposition: absolute;\n\tfont-size: 55rpx;\n\tfont-weight: 580;\n\tcolor: #1c1c1e;\n\tfont-family: \"Helvetica Neue\", \"PingFang SC\", \"Helvetica\", \"Arial\", sans-serif;\n\ttop: 130rpx;\n\tleft: 35rpx;\n}\n\n.chat-list-page {\n\tbackground-color: #ffffff;\n\tmin-height: 100vh;\n}\n\n.chat-list {\n\tpadding: 0 30rpx;\n}\n\n.chat-item {\n\tdisplay: flex;\n\talign-items: center;\n\tpadding: 30rpx 0;\n\tborder-bottom: 1rpx solid #f0f0f0;\n\ttransition: background-color 0.2s;\n\t&:last-child {\n\t\tborder-bottom: none;\n\t}\n\t&:active {\n\t\tbackground-color: #f5f5f5;\n\t}\n}\n\n.avatar {\n\twidth: 100rpx;\n\theight: 100rpx;\n\tborder-radius: 50%;\n\tmargin-right: 24rpx;\n\tflex-shrink: 0;\n\tbackground-color: #eee;\n}\n\n.chat-details {\n\tflex: 1;\n\tdisplay: flex;\n\tflex-direction: column;\n\tjustify-content: center;\n\toverflow: hidden;\n}\n\n.header {\n\tdisplay: flex;\n\tjustify-content: space-between;\n\talign-items: center;\n\tmargin-bottom: 8rpx;\n}\n\n.nickname {\n\tfont-size: 32rpx;\n\tcolor: #333;\n\tfont-weight: 500;\n}\n\n.last-time {\n\tfont-size: 24rpx;\n\tcolor: #999;\n\tflex-shrink: 0;\n}\n\n.footer {\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: space-between;\n\tgap: 16rpx;\n}\n\n.last-message {\n\tflex: 1;\n\tfont-size: 28rpx;\n\tcolor: #888;\n\toverflow: hidden;\n\ttext-overflow: ellipsis;\n\twhite-space: nowrap;\n}\n\n.badge {\n\tbackground-color: #fa3534;\n\tborder-radius: 999rpx;\n\tdisplay: inline-flex;\n\talign-items: center;\n\tjustify-content: center;\n\tpadding: 0 12rpx;\n\theight: 36rpx;\n\tmin-width: 36rpx;\n\tflex-shrink: 0;\n\tbox-sizing: border-box;\n\tanimation: pulse 1.5s infinite;\n\tbox-shadow: 0 4rpx 8rpx rgba(250, 53, 52, 0.3);\n\tmargin-bottom: 5rpx;\n}\n\n.badge-text {\n\tfont-size: 24rpx;\n\tcolor: #ffffff;\n\tfont-weight: bold;\n\tline-height: 1;\n}\n\n.empty-state {\n\tdisplay: flex;\n\tflex-direction: column;\n\talign-items: center;\n\tjustify-content: center;\n\tpadding-top: 280rpx;\n\t.empty-icon {\n\t\twidth: 300rpx;\n\t}\n\t.empty-text {\n\t\tfont-size: 30rpx;\n\t\tcolor: #333;\n\t\tmargin-top: 30rpx;\n\t}\n\t.empty-tip {\n\t\tfont-size: 26rpx;\n\t\tcolor: #999;\n\t\tmargin-top: 15rpx;\n\t}\n}\n\n.skeleton-container {\n\tpadding: 0 30rpx;\n}\n.skeleton-item {\n\tdisplay: flex;\n\talign-items: center;\n\tpadding: 40rpx 0;\n\tborder-bottom: 1rpx solid #f0f0f0;\n}\n.skeleton-avatar {\n\twidth: 120rpx;\n\theight: 120rpx;\n\tborder-radius: 50%;\n\tbackground-color: #E0E0E0;\n\tmargin-right: 24rpx;\n\tanimation: skeleton-shimmer 1.5s infinite ease-in-out;\n}\n.skeleton-details {\n\tflex: 1;\n\tdisplay: flex;\n\tflex-direction: column;\n\tjustify-content: space-around;\n\theight: 100rpx;\n}\n.skeleton-line-long {\n\twidth: 80%;\n\theight: 36rpx;\n\tbackground-color: #E0E0E0;\n\tborder-radius: 8rpx;\n\tanimation: skeleton-shimmer 1.5s infinite ease-in-out;\n}\n.skeleton-line-short {\n\twidth: 50%;\n\theight: 28rpx;\n\tbackground-color: #E0E0E0;\n\tborder-radius: 8rpx;\n\tanimation: skeleton-shimmer 1.5s infinite ease-in-out;\n}\n\n@keyframes skeleton-shimmer {\n\t0% {\n\t\topacity: 0.5;\n\t}\n\t50% {\n\t\topacity: 1;\n\t}\n\t100% {\n\t\topacity: 0.5;\n\t}\n}\n</style>","import MiniProgramPage from 'D:/peng.folder/fengdian-main/fengdian-main/pages/chatList/chatList.vue'\ntt.createPage(MiniProgramPage)"],"names":["ref","onLoad","uni","onShow","onHide","onUnload","uniCloud"],"mappings":"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"}