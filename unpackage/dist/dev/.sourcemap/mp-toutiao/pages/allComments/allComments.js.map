{"version":3,"file":"allComments.js","sources":["pages/allComments/allComments.vue","../../../HBuilderX.4.66.2025051912/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvYWxsQ29tbWVudHMvYWxsQ29tbWVudHMudnVl"],"sourcesContent":["<template>\n\t<view class=\"all-comments-page\">\n\t\t<view class=\"technician-header\" v-if=\"technicianInfo\">\n\t\t\t<image :src=\"technicianInfo.avatar\" class=\"header-avatar\" />\n\t\t\t<view class=\"header-name\">{{ technicianInfo.name }} 的全部评价</view>\n\t\t</view>\n\n\t\t<view class=\"comment-list\">\n\t\t\t<view v-if=\"loading\" class=\"loading-tip\">加载中...</view>\n\t\t\t<view v-if=\"!loading && comments.length === 0\" class=\"no-data-tip\">暂无用户评价</view>\n\t\t\t\n\t\t\t<view class=\"comment-item\" v-for=\"item in comments\" :key=\"item.appointmentId\">\n\t\t\t\t<view class=\"comment-header\">\n\t\t\t\t\t<image class=\"comment-avatar\" :src=\"item.avatar\" />\n\t\t\t\t\t<view class=\"comment-info\">\n\t\t\t\t\t\t<view class=\"comment-name\">{{ item.name }}</view>\n\t\t\t\t\t\t<view class=\"comment-date\">{{ formatDate(item.createdAt) }}</view>\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t\t<view class=\"comment-rating\" v-if=\"item.rating\">\n\t\t\t\t\t<text v-for=\"star in 5\" :key=\"star\" class=\"star\" :class=\"{ 'active': star <= item.rating }\">★</text>\n\t\t\t\t</view>\n\t\t\t\t<view class=\"comment-content\">{{ item.comment }}</view>\n\t\t\t\t<view class=\"comment-images\" v-if=\"item.images && item.images.length > 0\">\n\t\t\t\t\t<image v-for=\"(img, imgIndex) in item.images\" :key=\"imgIndex\" :src=\"img\" mode=\"aspectFill\" class=\"comment-img\" />\n\t\t\t\t</view>\n\n\t\t\t\t<view class=\"comment-actions\">\n\t\t\t\t\t<view class=\"reply-btn\" @click=\"toggleReplyInput(item.appointmentId)\">回复</view>\n\t\t\t\t</view>\n\t\t\t\t\n\t\t\t\t<view class=\"replies-wrapper\" v-if=\"item.replies && item.replies.length > 0\">\n\t\t\t\t\t<view class=\"reply-list\" v-show=\"replyState[item.appointmentId]?.showReplies\">\n<view class=\"reply-item\" v-for=\"reply in item.replies\" :key=\"reply.replyId\">\n  <image class=\"reply-avatar\" :src=\"reply.userAvatar\" />\n  <view class=\"reply-content\">\n    <view class=\"reply-header\">\n      <text class=\"reply-name\">{{ reply.userName }}</text>\n      <text class=\"reply-date\">{{ formatDate(reply.createdAt) }}</text>\n    </view>\n    <view class=\"reply-text\">{{ reply.content }}</view>\n  </view>\n</view>\n\n\t\t\t\t\t</view>\n\t\t\t\t\t<view class=\"toggle-replies\" @click=\"toggleReplies(item.appointmentId)\">\n\t\t\t\t\t\t{{ replyState[item.appointmentId]?.showReplies ? '收起回复' : `查看全部 ${item.replies.length} 条回复` }}\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t\t\n\t\t\t\t<view class=\"reply-input-area\" v-if=\"replyState[item.appointmentId]?.showInput\">\n\t\t\t\t\t<input class=\"reply-input\" v-model=\"replyState[item.appointmentId].content\" placeholder=\"输入你的回复...\" />\n\t\t\t\t\t<button class=\"reply-submit-btn\" size=\"mini\" @click=\"handleReplySubmit(item.appointmentId)\">发送</button>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t</view>\n\n\t\t<view class=\"load-more-tip\">\n\t\t\t<text v-if=\"isLoadMore\">正在加载...</text>\n\t\t\t<text v-if=\"!hasMoreData && comments.length > 0\">没有更多评价了</text>\n\t\t</view>\n\n\t</view>\n</template>\n\n<script setup>\nimport { ref, reactive } from 'vue';\nimport { onLoad, onReachBottom } from '@dcloudio/uni-app';\n\nconst technicianId = ref('');\nconst technicianInfo = ref(null);\nconst comments = ref([]);\nconst replyState = reactive({});\n\nconst loading = ref(true);\nconst isLoadMore = ref(false);\nconst hasMoreData = ref(true);\nconst page = ref(1);\nconst pageSize = 10; // 每页加载10条\n\nonLoad((options) => {\n\tif (options.technicianId) {\n\t\ttechnicianId.value = options.technicianId;\n\t\tfetchComments();\n\t} else {\n\t\tuni.showToast({ title: '参数错误', icon: 'none' });\n\t\tloading.value = false;\n\t}\n});\n\nonReachBottom(() => {\n\tif (hasMoreData.value && !isLoadMore.value) {\n\t\tpage.value++;\n\t\tfetchComments(true);\n\t}\n});\n\nconst fetchComments = async (isLoadMoreAction = false) => {\n\tif (isLoadMoreAction) {\n\t\tisLoadMore.value = true;\n\t} else {\n\t\tloading.value = true;\n\t}\n\n\ttry {\n\t\tconst res = await uniCloud.callFunction({\n\t\t\tname: 'getCommentsByTechnicianId',\n\t\t\tdata: {\n\t\t\t\ttechnicianId: technicianId.value,\n\t\t\t\tpage: page.value,\n\t\t\t\tpageSize: pageSize\n\t\t\t}\n\t\t});\n\n\t\tif (res.result.success) {\n\t\t\tconst { commentData, total, techInfo } = res.result;\n\t\t\t\n\t\t\t// 只在第一次加载时设置技工信息\n\t\t\tif (!technicianInfo.value) {\n\t\t\t\ttechnicianInfo.value = techInfo;\n\t\t\t}\n\t\t\t\n\t\t\t// 初始化新加载评论的回复状态\n\t\t\tcommentData.forEach(comment => {\n\t\t\t\tif (!replyState[comment.appointmentId]) {\n\t\t\t\t\treplyState[comment.appointmentId] = {\n\t\t\t\t\t\tshowReplies: false,\n\t\t\t\t\t\tshowInput: false,\n\t\t\t\t\t\tcontent: ''\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tcomments.value = isLoadMoreAction ? [...comments.value, ...commentData] : commentData;\n\t\t\thasMoreData.value = comments.value.length < total;\n\n\t\t} else {\n\t\t\tuni.showToast({ title: res.result.message || '加载失败', icon: 'none' });\n\t\t}\n\t} catch (err) {\n\t\tconsole.error('获取评论失败', err);\n\t\tuni.showToast({ title: '网络错误，请重试', icon: 'none' });\n\t} finally {\n\t\tloading.value = false;\n\t\tisLoadMore.value = false;\n\t}\n};\n\nconst refreshComments = () => {\n\tpage.value = 1;\n\tcomments.value = [];\n\thasMoreData.value = true;\n\tfetchComments();\n};\n\n\n// 复用 HomepageDetail 的方法\nconst formatDate = (timestamp) => {\n    const date = new Date(timestamp);\n    return date.toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });\n};\n\nconst toggleReplies = (commentId) => {\n    if (replyState[commentId]) {\n        replyState[commentId].showReplies = !replyState[commentId].showReplies;\n    }\n};\n\nconst toggleReplyInput = (commentId) => {\n    const userInfo = uni.getStorageSync('userinfo');\n    if (!userInfo || !userInfo._id) {\n        uni.showToast({ title: '请先登录再回复', icon: 'none' });\n        return;\n    }\n    if (replyState[commentId]) {\n        replyState[commentId].showInput = !replyState[commentId].showInput;\n    }\n};\n\n// allComments.vue 中的 handleReplySubmit 完整版\n// 假设在 HomepageDetail.vue 或 allComments.vue 中\nconst handleReplySubmit = async (commentId) => {\n  const replyContent = replyState[commentId].content;\n  if (!replyContent.trim()) {\n    uni.showToast({ title: '回复内容不能为空', icon: 'none' });\n    return;\n  }\n\n  // 从本地 storage 读取 userinfo\n  const storageUser = uni.getStorageSync('userinfo');\n  if (!storageUser || !storageUser._id) {\n    uni.showToast({ title: '请先登录再回复', icon: 'none' });\n    return;\n  }\n\n  // 只透传必要字段：_id, 昵称, 头像\n  const caller = {\n    _id: storageUser._id,\n    nickname: storageUser.name || storageUser.nickname || '', // 优先用 name 或 nickname\n    avatar: storageUser.avatar || ''                         // 本地存的 avatar 字段\n  };\n\n  uni.showLoading({ title: '正在提交...' });\n  try {\n    const res = await uniCloud.callFunction({\n      name: 'addCommentReply',\n      data: {\n        homepageId: detail.value._id,  // 或 technicianId.value\n        commentId,\n        content: replyContent.trim(),\n        userInfo: caller              // 透传 caller 对象\n      }\n    });\n    uni.hideLoading();\n\n    if (res.result.success) {\n      uni.showToast({ title: '回复成功', icon: 'success' });\n      // 重置输入框并刷新\n      replyState[commentId].content = '';\n      replyState[commentId].showInput = false;\n      getDetail();      // 或 refreshComments()\n    } else {\n      uni.showToast({ title: res.result.message || '回复失败', icon: 'none' });\n    }\n  } catch (err) {\n    uni.hideLoading();\n    uni.showToast({ title: '回复失败，请重试', icon: 'none' });\n    console.error('回复提交失败', err);\n  }\n};\n\n\n\n</script>\n\n<style lang=\"scss\">\n.all-comments-page {\n\tbackground-color: #f8f8f8;\n\tmin-height: 100vh;\n\tpadding-bottom: 40rpx;\n}\n\n.technician-header {\n\tdisplay: flex;\n\talign-items: center;\n\tpadding: 20rpx;\n\tbackground-color: #fff;\n\tborder-bottom: 1rpx solid #eee;\n\n\t.header-avatar {\n\t\twidth: 80rpx;\n\t\theight: 80rpx;\n\t\tborder-radius: 50%;\n\t\tmargin-right: 20rpx;\n\t}\n\n\t.header-name {\n\t\tfont-size: 32rpx;\n\t\tfont-weight: bold;\n\t\tcolor: #333;\n\t}\n}\n\n.comment-list {\n\t.loading-tip,\n\t.no-data-tip {\n\t\ttext-align: center;\n\t\tcolor: #999;\n\t\tpadding: 40rpx 0;\n\t}\n}\n\n.load-more-tip {\n\ttext-align: center;\n\tcolor: #999;\n\tfont-size: 26rpx;\n\tpadding: 20rpx 0;\n}\n\n/* 复用 HomepageDetail 的评论样式 */\n.comment-item {\n\tbackground: #fff;\n\tmargin-top: 20rpx;\n\tpadding: 20rpx;\n\n\t.comment-header {\n\t\tdisplay: flex;\n\t\talign-items: center;\n\n\t\t.comment-avatar {\n\t\t\twidth: 60rpx;\n\t\t\theight: 60rpx;\n\t\t\tborder-radius: 50%;\n\t\t\tmargin-right: 16rpx;\n\t\t}\n\n\t\t.comment-info {\n\t\t\t.comment-name {\n\t\t\t\tfont-weight: bold;\n\t\t\t\tfont-size: 28rpx;\n\t\t\t}\n\t\t\t.comment-date {\n\t\t\t\tfont-size: 24rpx;\n\t\t\t\tcolor: #999;\n\t\t\t}\n\t\t}\n\t}\n\t\n\t.comment-rating {\n\t\tmargin-top: 10rpx;\n\t\tmargin-left: 76rpx;\n\t\tdisplay: flex;\n\t\t.star {\n\t\t\tfont-size: 32rpx;\n\t\t\tcolor: #ccc;\n\t\t\t&.active {\n\t\t\t\tcolor: #ffc107;\n\t\t\t}\n\t\t}\n\t}\n\t\n\t.comment-content {\n\t\tmargin-top: 16rpx;\n\t\tpadding-left: 20rpx;\n\t\tfont-size: 30rpx;\n\t\tcolor: #444;\n\t}\n\t\n\t.comment-images {\n\t\tmargin-top: 10rpx;\n\t\tpadding-left: 20rpx;\n\t\tdisplay: flex;\n\t\tflex-wrap: wrap;\n\t\t.comment-img {\n\t\t\twidth: 120rpx;\n\t\t\theight: 120rpx;\n\t\t\tmargin-right: 10rpx;\n\t\t\tmargin-bottom: 10rpx;\n\t\t\tborder-radius: 10rpx;\n\t\t}\n\t}\n\n\t.comment-actions {\n\t\tdisplay: flex;\n\t\tjustify-content: flex-end;\n\t\tmargin-top: 16rpx;\n\t\t.reply-btn {\n\t\t\tfont-size: 24rpx;\n\t\t\tcolor: #007aff;\n\t\t\tpadding: 4rpx 12rpx;\n\t\t\tborder-radius: 20rpx;\n\t\t\tbackground-color: #f0f5ff;\n\t\t}\n\t}\n\n\t.replies-wrapper {\n\t\tmargin-top: 20rpx;\n\t\tpadding: 20rpx;\n\t\tbackground-color: #f7f7f7;\n\t\tborder-radius: 10rpx;\n\n\t\t.reply-list {\n\t\t\t.reply-item {\n\t\t\t\tdisplay: flex;\n\t\t\t\tmargin-bottom: 16rpx;\n\t\t\t\t&:last-child {\n\t\t\t\t\tmargin-bottom: 0;\n\t\t\t\t}\n\n\t\t\t\t.reply-avatar {\n\t\t\t\t\twidth: 50rpx;\n\t\t\t\t\theight: 50rpx;\n\t\t\t\t\tborder-radius: 50%;\n\t\t\t\t\tmargin-right: 16rpx;\n\t\t\t\t\tflex-shrink: 0;\n\t\t\t\t}\n\n\t\t\t\t.reply-content {\n\t\t\t\t\tflex: 1;\n\t\t\t\t\t.reply-name {\n\t\t\t\t\t\tfont-size: 26rpx;\n\t\t\t\t\t\tfont-weight: bold;\n\t\t\t\t\t\tcolor: #333;\n\t\t\t\t\t}\n\t\t\t\t\t.reply-text {\n\t\t\t\t\t\tfont-size: 26rpx;\n\t\t\t\t\t\tcolor: #555;\n\t\t\t\t\t\tword-break: break-all;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t.toggle-replies {\n\t\t\ttext-align: left;\n\t\t\tfont-size: 26rpx;\n\t\t\tcolor: #007aff;\n\t\t\tpadding-top: 10rpx;\n\t\t\tborder-top: 1rpx solid #eee;\n\t\t\tmargin-top: 10rpx;\n\t\t}\n\t}\n\n\t.reply-input-area {\n\t\tdisplay: flex;\n\t\talign-items: center;\n\t\tmargin-top: 20rpx;\n\t\t.reply-input {\n\t\t\tflex: 1;\n\t\t\tbackground-color: #f2f2f2;\n\t\t\theight: 60rpx;\n\t\t\tline-height: 60rpx;\n\t\t\tfont-size: 28rpx;\n\t\t\tpadding: 0 20rpx;\n\t\t\tborder-radius: 30rpx;\n\t\t}\n\t\t.reply-submit-btn {\n\t\t\tmargin-left: 20rpx;\n\t\t\tbackground-color: #007aff;\n\t\t\tcolor: #fff;\n\t\t}\n\t}\n}\r\n.reply-header {\n  flex-direction: row;\n  justify-content: space-between;\n  align-items: center;\n  margin-bottom: 8rpx;\n}\n\n.reply-date {\n  font-size: 24rpx;\n  color: #999;\n}\n\n</style>","import MiniProgramPage from 'D:/peng.folder/fengdian-main/fengdian-main/pages/allComments/allComments.vue'\ntt.createPage(MiniProgramPage)"],"names":["ref","reactive","onLoad","uni","onReachBottom","uniCloud","MiniProgramPage"],"mappings":"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"}