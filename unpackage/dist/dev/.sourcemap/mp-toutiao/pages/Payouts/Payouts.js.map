{"version":3,"file":"Payouts.js","sources":["pages/Payouts/Payouts.vue","../../../HBuilderX.4.66.2025051912/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvUGF5b3V0cy9QYXlvdXRzLnZ1ZQ"],"sourcesContent":["<template>\n  <view class=\"page-container\">\n\n    <!-- 提现信息卡片 -->\n    <view class=\"card balance-card\">\n      <view class=\"card-header\">\n        <text class=\"card-title\">我的余额</text>\n      </view>\n      <view class=\"card-body\">\n        <view class=\"balance-row\">\n          <text class=\"balance-label\">可提现金额:</text>\n          <view class=\"balance-amount\">\n            <text class=\"currency-symbol\">¥</text>\n            <text class=\"amount\">{{ availableBalance.toFixed(2) }}</text>\n          </view>\n        </view>\n        <view class=\"balance-row\">\n          <text class=\"balance-label\">提现审核中:</text>\n          <view class=\"balance-amount\">\n            <text class=\"currency-symbol\">¥</text>\n            <text class=\"amount status-pending\">{{ pendingWithdrawalAmount.toFixed(2) }}</text>\n          </view>\n        </view>\n      </view>\n      <view class=\"card-footer\">\n        <button class=\"btn primary-btn\" @click=\"requestWithdrawal\" :disabled=\"availableBalance <= 0 || isRequesting\">\n          {{ isRequesting ? '正在申请...' : '一键提现' }}\n        </button>\n      </view>\n    </view>\n\n    <!-- 提现历史记录 -->\n    <view class=\"card history-card\">\n      <view class=\"card-header\">\n        <text class=\"card-title\">提现记录</text>\n      </view>\n      <view class=\"card-body\">\n        <view v-if=\"historyLoading\" class=\"loading-state\">\n          <text>加载中...</text>\n        </view>\n        <view v-else-if=\"withdrawalHistory.length === 0\" class=\"empty-state\">\n          <text>暂无提现记录</text>\n        </view>\n        <view v-else class=\"history-list\">\n          <view v-for=\"record in withdrawalHistory\" :key=\"record._id\" class=\"history-item\">\n            <view class=\"item-info\">\n              <text class=\"item-amount\">¥{{ record.amount.toFixed(2) }}</text>\n              <text class=\"item-date\">{{ formatTimestamp(record.requestAt) }}</text>\n            </view>\n            <view class=\"item-status\" :class=\"getStatusClass(record.status)\">\n              {{ formatWithdrawalStatus(record.status) }}\n            </view>\n          </view>\n        </view>\n      </view>\n    </view>\n\n    <!-- 自定义消息提示框 -->\n    <view class=\"custom-message-popup\" :class=\"{ 'show': popupVisible, [popupMessageType]: true }\">\n      <text class=\"popup-text\">{{ popupMessageText }}</text>\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport { ref, onMounted } from 'vue';\nimport { onShow } from '@dcloudio/uni-app';\n\nconst availableBalance = ref(0); // 可提现金额\nconst pendingWithdrawalAmount = ref(0); // 提现审核中的金额\nconst withdrawalHistory = ref([]); // 提现历史记录\nconst isRequesting = ref(false); // 提现请求中状态\nconst historyLoading = ref(true); // 历史记录加载状态\n\n// 消息提示框相关\nconst popupVisible = ref(false);\nconst popupMessageType = ref('success'); // success, error, info\nconst popupMessageText = ref('');\nlet popupTimer = null; // 用于控制消息框自动隐藏的定时器\n\n// 状态栏高度\nconst statusBarHeight = ref(0);\n\n// 获取系统信息，用于计算状态栏高度\nonMounted(() => {\n  uni.getSystemInfo({\n    success: (res) => {\n      statusBarHeight.value = res.statusBarHeight;\n    }\n  });\n});\n\n// 返回上一页\nconst goBack = () => {\n  uni.navigateBack();\n};\n\n// 格式化时间戳\nconst formatTimestamp = (timestamp) => {\n  if (!timestamp) return '';\n  const date = new Date(timestamp);\n  // 使用 toLocaleString 格式化日期和时间，更符合本地习惯\n  return date.toLocaleString('zh-CN', {\n    year: 'numeric',\n    month: '2-digit',\n    day: '2-digit',\n    hour: '2-digit',\n    minute: '2-digit',\n    hour12: false // 24小时制\n  });\n};\n\n// 格式化提现状态\nconst formatWithdrawalStatus = (status) => {\n  const map = {\n    pending_review: '待审核',\n    completed: '已打款',\n    rejected: '已拒绝',\n    failed: '打款失败'\n  };\n  return map[status] || '未知状态';\n};\n\n// 获取状态对应的CSS类\nconst getStatusClass = (status) => {\n  switch (status) {\n    case 'pending_review':\n      return 'status-pending';\n    case 'completed':\n      return 'status-completed';\n    case 'rejected':\n    case 'failed':\n      return 'status-failed';\n    default:\n      return '';\n  }\n};\n\n// 显示消息提示\nconst showMessage = (type, text, duration = 2000) => {\n  if (popupTimer) {\n    clearTimeout(popupTimer);\n  }\n  popupMessageType.value = type;\n  popupMessageText.value = text;\n  popupVisible.value = true;\n  popupTimer = setTimeout(() => {\n    popupVisible.value = false;\n    popupTimer = null;\n  }, duration);\n};\n\n// 获取工人可提现金额和审核中金额\nconst fetchBalances = async () => {\n  const userinfo = uni.getStorageSync('userinfo');\n  if (!userinfo || !userinfo._id) {\n    showMessage('error', '请先登录');\n    return;\n  }\n  try {\n    const res = await uniCloud.callFunction({\n      name: 'getWorkerAvailableBalance',\n      data: { userId: userinfo._id }\n    });\n    if (res.result && res.result.success) {\n      availableBalance.value = res.result.availableBalance;\n      pendingWithdrawalAmount.value = res.result.pendingWithdrawalAmount;\n    } else {\n      console.error('获取金额失败:', res.result.message);\n      showMessage('error', res.result.message || '获取余额失败');\n    }\n  } catch (e) {\n    console.error('调用云函数 getWorkerAvailableBalance 失败:', e);\n    showMessage('error', '获取余额网络错误');\n  }\n};\n\n// 获取提现历史记录\nconst fetchWithdrawalHistory = async () => {\n  historyLoading.value = true;\n  const userinfo = uni.getStorageSync('userinfo');\n  if (!userinfo || !userinfo._id) {\n    historyLoading.value = false;\n    return;\n  }\n  try {\n    const res = await uniCloud.callFunction({\n      name: 'getWithdrawalHistory',\n      data: { userId: userinfo._id }\n    });\n    if (res.result && res.result.success) {\n      // 将提现金额从分转换为元\n      withdrawalHistory.value = res.result.data.map(record => ({\n        ...record,\n        amount: record.amount / 100 // 假设数据库存储的是分\n      }));\n    } else {\n      console.error('获取提现历史失败:', res.result.message);\n      showMessage('error', res.result.message || '获取历史失败');\n    }\n  } catch (e) {\n    console.error('调用云函数 getWithdrawalHistory 失败:', e);\n    showMessage('error', '获取历史网络错误');\n  } finally {\n    historyLoading.value = false;\n  }\n};\n\n// 申请提现 (一键提现所有可提现金额)\nconst requestWithdrawal = async () => {\n  if (availableBalance.value <= 0) {\n    showMessage('info', '当前无可提现金额');\n    return;\n  }\n\n  const confirmRes = await uni.showModal({\n    title: '确认提现',\n    content: `您确定要提现所有可提现金额 ¥${availableBalance.value.toFixed(2)} 吗？`,\n    confirmText: '确认提现',\n    cancelText: '取消'\n  });\n\n  if (!confirmRes.confirm) {\n    return;\n  }\n\n  isRequesting.value = true;\n  uni.showLoading({ title: '正在提交提现申请...', mask: true });\n\n  const userinfo = uni.getStorageSync('userinfo');\n  if (!userinfo || !userinfo._id || !userinfo.phoneNumber) { \n    showMessage('error', '无法获取用户信息，请重新登录');\n    isRequesting.value = false;\n    uni.hideLoading();\n    return;\n  }\n\n  try {\n    const res = await uniCloud.callFunction({\n      name: 'requestWorkerFullWithdrawal',\n      data: {\n        userId: userinfo._id,\n        workerPhone: userinfo.phoneNumber,\n      }\n    });\n\n    if (res.result && res.result.success) {\n      showMessage('success', '提现申请已提交，请等待平台审核');\n      // 刷新余额和历史记录\n      fetchBalances(); // 获取两个余额\n      fetchWithdrawalHistory();\n    } else {\n      console.error('提现申请失败:', res.result.message);\n      showMessage('error', res.result.message || '提现申请失败');\n    }\n  } catch (e) {\n    console.error('调用云函数 requestWorkerFullWithdrawal 失败:', e);\n    showMessage('error', '提现网络错误，请重试');\n  } finally {\n    isRequesting.value = false;\n    uni.hideLoading();\n  }\n};\n\n// 页面加载和显示时刷新数据\nonMounted(() => {\n  fetchBalances(); // 获取两个余额\n  fetchWithdrawalHistory();\n});\n\nonShow(() => {\n  fetchBalances(); // 获取两个余额\n  fetchWithdrawalHistory();\n});\n</script>\n\n<style lang=\"scss\">\n.page-container {\n  min-height: 100vh;\n}\n\n\n.card {\n  background-color: #fff;\n  margin: 35rpx;\n  border-radius: 16rpx;\n  box-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.05);\n  overflow: hidden; // 确保圆角生效\n}\n\n.card-header {\n  padding: 24rpx 30rpx;\n  border-bottom: 1rpx solid #eee;\n  display: flex;\n  align-items: center;\n}\n\n.card-title {\n  font-size: 32rpx;\n  font-weight: bold;\n  color: #333;\n}\n\n.card-body {\n  padding: 30rpx;\n}\n\n.balance-card {\n  .balance-row {\n    display: flex;\n    justify-content: space-between;\n    align-items: baseline;\n    margin-bottom: 15rpx;\n    &:last-child {\n      margin-bottom: 0;\n    }\n  }\n  .balance-label {\n    font-size: 28rpx;\n    color: #666;\n    flex-shrink: 0; /* 防止文字被压缩 */\n  }\n  .balance-amount {\n    display: flex;\n    align-items: baseline;\n    margin-left: 20rpx; /* 与label的间距 */\n    .currency-symbol {\n      font-size: 36rpx;\n      font-weight: bold;\n      color: #333;\n      margin-right: 8rpx;\n    }\n    .amount {\n      font-size: 56rpx; /* 比总额稍小 */\n      font-weight: bold;\n      color: #007aff; /* 主题蓝 */\n    }\n    /* 修正：将 .pending-amount 直接作用于 .amount */\n    &.status-pending { /* 使用更具体的选择器，确保只应用于审核中金额 */\n      color: #ff9900; /* 审核中金额使用橙色 */\n    }\n  }\n  .card-footer {\n    padding: 20rpx 30rpx 30rpx;\n    border-top: 1rpx solid #eee;\n    text-align: center;\n  }\n  .primary-btn {\n    background-color: #007aff; /* 主题蓝 */\n    color: #fff;\n    border-radius: 50rpx;\n    font-size: 32rpx;\n    padding: 20rpx 0;\n    width: 80%;\n    &:active {\n      opacity: 0.8;\n    }\n    &[disabled] {\n      background-color: #a0cfff; /* 禁用状态的蓝色 */\n      color: #fff;\n    }\n  }\n}\n\n.history-card {\n  .history-list {\n    .history-item {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      padding: 20rpx 0;\n      border-bottom: 1rpx solid #f0f0f0;\n      &:last-child {\n        border-bottom: none;\n      }\n      .item-info {\n        display: flex;\n        flex-direction: column;\n        .item-amount {\n          font-size: 32rpx;\n          font-weight: bold;\n          color: #333;\n        }\n        .item-date {\n          font-size: 24rpx;\n          color: #999;\n          margin-top: 4rpx;\n        }\n      }\n      .item-status {\n        font-size: 28rpx;\n        padding: 8rpx 16rpx;\n        border-radius: 10rpx;\n        font-weight: bold;\n        &.status-pending { /* 提现记录中的“待审核” */\n          color: #ff9900; /* 橙色 */\n          background-color: #fff3e0;\n        }\n        &.status-completed {\n          color: #007aff; /* 蓝色 */\n          background-color: #e6f7ff;\n        }\n        &.status-rejected, /* 拒绝 */\n        &.status-failed { /* 失败 */\n          color: #ff4d4f; /* 红色 */\n          background-color: #ffe6e6;\n        }\n      }\n    }\n  }\n}\n\n.loading-state, .empty-state {\n  text-align: center;\n  padding: 60rpx;\n  color: #999;\n  font-size: 28rpx;\n}\n\n/* 自定义消息提示框样式 */\n.custom-message-popup {\n  position: fixed;\n  top: 50%;\n  left: 50%;\n  transform: translate(-50%, -50%);\n  background-color: rgba(0, 0, 0, 0.7);\n  color: #fff;\n  padding: 20rpx 40rpx;\n  border-radius: 16rpx;\n  font-size: 28rpx;\n  text-align: center;\n  z-index: 1000;\n  opacity: 0;\n  visibility: hidden;\n  transition: opacity 0.3s ease, visibility 0.3s ease;\n\n  &.show {\n    opacity: 1;\n    visibility: visible;\n  }\n\n  &.success {\n    background-color: rgba(40, 167, 69, 0.8); /* Green */\n  }\n  &.error {\n    background-color: rgba(220, 53, 69, 0.8); /* Red */\n  }\n  &.info {\n    background-color: rgba(23, 162, 184, 0.8); /* Blue-ish */\n  }\n}\n</style>\n","import MiniProgramPage from 'D:/peng.folder/fengdian-main/fengdian-main/pages/Payouts/Payouts.vue'\ntt.createPage(MiniProgramPage)"],"names":["ref","onMounted","uni","uniCloud","onShow","MiniProgramPage"],"mappings":"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"}