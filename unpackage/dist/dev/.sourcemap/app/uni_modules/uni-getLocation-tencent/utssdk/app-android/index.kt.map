{"version":3,"sources":["uni_modules/uni-getLocation-tencent/utssdk/app-android/index.uts","uni_modules/uni-getLocation-tencent/utssdk/interface.uts"],"sourcesContent":["import {\n\tUTSAndroid\n} from \"io.dcloud.uts\";\n\nimport ActivityCompat from \"androidx.core.app.ActivityCompat\";\nimport Manifest from \"android.Manifest\";\nimport Looper from \"android.os.Looper\";\nimport TencentLocationManager from \"com.tencent.map.geolocation.TencentLocationManager\";\nimport TencentLocationListener from \"com.tencent.map.geolocation.TencentLocationListener\";\nimport TencentLocation from \"com.tencent.map.geolocation.TencentLocation\";\nimport TencentLocationRequest from \"com.tencent.map.geolocation.TencentLocationRequest\";\nimport PackageManager from \"android.content.pm.PackageManager\";\nimport Class from 'java.lang.Class';\nimport Exception from 'java.lang.Exception';\n\nimport { GetLocation, GetLocationOptions, GetLocationSuccess,GetLocationFail } from \"../interface.uts\"\n\n\n\nexport const getLocation : GetLocation = function (options : GetLocationOptions) {\n\n\tif(!checkHasIntegration()){\n\t\t// 当前没有集成腾讯sdk，提示需要打包\n\t\tlet ret = new UniError(\"uni-getLocation-tencent\",-10,\"需要打自定义基座\");\n\t\t\n\t\toptions.fail?.(ret)\n\t\toptions.complete?.(ret)\n\t\treturn;\n\t}\n\tif (!checkLocationConfig()) {\n\t\tlet ret = new UniError(\"uni-getLocation-tencent\",-20,\"未通过配置预校验，通常是app key 配置错误\");\n\t\toptions.fail?.(ret)\n\t\toptions.complete?.(ret)\n\t\treturn;\n\t}\n\t\n\t/**\n\t * 准备权限\n\t */\n\tlet permissionNeed = [\"android.permission.ACCESS_FINE_LOCATION\"];\n\tUTSAndroid.requestSystemPermission(UTSAndroid.getUniActivity()!, permissionNeed, function (allRight:boolean,_grantedList:string[]) {\n\t\tif (allRight) {\n\t\t\t// 交给目前的location 引擎，真实执行\n\t\t\tgetLocationImpl(options)\n\t\t}\n\t}, function (_doNotAskAgain:boolean,_grantedList:string[]) {\n\t\t__f__('log','at uni_modules/uni-getLocation-tencent/utssdk/app-android/index.uts:47',\"用户拒绝了部分权限:\")\n\t\tlet ret = new UniError(\"uni-getLocation-tencent\",-30,\"permission missed.\");\n\t\toptions.fail?.(ret)\n\t\toptions.complete?.(ret)\n\t})\n\n\n}\n\n\n/****************************************内部功能实现****************************************************/\n\n\n/**\n * 定位监听结果包装类\n */\nclass LocationOptionsWapper {\n\n\thostOption : GetLocationOptions;\n\n\tconstructor(option : GetLocationOptions) {\n\t\tthis.hostOption = option\n\t}\n\n\tonLocationChanged(location : TencentLocation, _error : Int,\n\t\t_reason : string) {\n\n\t\tlet ret : GetLocationSuccess = {\n\t\t\tlatitude: location.latitude,\n\t\t\tlongitude: location.longitude,\n\t\t\tspeed: 0,\n\t\t\taccuracy: location.accuracy,\n\t\t\taltitude: location.altitude,\n\t\t\tverticalAccuracy: 0,\n\t\t\thorizontalAccuracy: location.accuracy,\n\t\t\taddress: location.address\n\t\t}\n\n\t\tthis.hostOption.success?.(ret)\n\t\t// 包装数据结构返回\n\t}\n\n\n\tonStatusUpdate(_name : string, _status : Int, _desc : string) {\n\t\t// 定位状态发生变化\n\t}\n};\n\n\n/**\n * Tencent 定位监听实现类\n */\nclass SingleLocationListener extends TencentLocationListener {\n\n\n\thostOptionWraper : LocationOptionsWapper;\n\n\tconstructor(option : LocationOptionsWapper) {\n\t\tsuper();\n\t\tthis.hostOptionWraper = option\n\t}\n\n\toverride onLocationChanged(location : TencentLocation, error : Int,\n\t\treason : string) : void {\n\t\tthis.hostOptionWraper.onLocationChanged(location, error, reason);\n\t}\n\n\toverride onStatusUpdate(name : string, status : Int, desc : string) : void {\n\t\tthis.hostOptionWraper.onStatusUpdate(name, status, desc);\n\t}\n\n}\n/**\n * 判断当前的基座是否已经集成了sdk, 即是否是自定义基座\n */\nfunction checkHasIntegration() : boolean {\n\n\tlet hasIntegration = true\n\ttry {\n\t\tlet xClass = Class.forName(\"com.tencent.map.geolocation.TencentLocationListener\")\n\t} catch (e : Exception) {\n\t\thasIntegration = false;\n\t}\n\n\tif (!hasIntegration) {\n\t\treturn false;\n\t}\n\n\treturn true\n}\n/**\n * 检查定位的相关配置是否正确\n */\nfunction checkLocationConfig() : boolean {\n\n\tlet packageName = UTSAndroid.getAppContext()!.getPackageName();\n\tlet appInfo = UTSAndroid.getAppContext()!.getPackageManager()!.getApplicationInfo(packageName, PackageManager.GET_META_DATA)\n\n\tlet metaData = appInfo.metaData\n\tif (metaData == null) {\n\t\treturn false;\n\t}\n\tlet adId = metaData.getString(\"TencentMapSDK\")\n\tif (adId == null) {\n\t\treturn false;\n\t}\n\tlet splitArray = adId!.split(\"-\")\n\tlet keyCharNum = splitArray.size\n\n\tif (keyCharNum > 5) {\n\t\t// 存在超过5个-，说明是符合规则的appkey\n\t\treturn true;\n\t}\n\t// 不符合校验规则，打回\n\treturn false;\n}\n\n\n/**\n * 腾讯地图获取定位信息\n * 参考文档:https://lbs.qq.com/mobile/androidLocationSDK/androidGeoGuide/androidGeoAdapt\n */\nfunction getLocationImpl(locationOptions : GetLocationOptions) {\n\t\n\tif(locationOptions.type != null && locationOptions.type!.toUpperCase() != 'GCJ-02'  && locationOptions.type!.toUpperCase() != 'GCJ02'){\n\t\t// 腾讯定位只支持GCJ-02，如果不是则报错\n\t\tlet ret = new UniError(\"uni-getLocation-tencent\",-1,\"GCJ-02 support only.\");\n\t\tlocationOptions.fail?.(ret)\n\t\tlocationOptions.complete?.(ret)\n\t\treturn\n\t}\n\n\tlet mLocationManager = TencentLocationManager.getInstance(UTSAndroid.getAppContext());\n\t// 定位监听器封装\n\tlet locationOptionWrapper = new LocationOptionsWapper(locationOptions);\n\tlet mLocationListener = new SingleLocationListener(locationOptionWrapper);\n\t// 发起单次请求\n\tlet locationRequest = TencentLocationRequest.create()\n\t// 是否需要逆地理编码\n\tif (locationOptions.geocode != null && locationOptions.geocode == true) {\n\t\tlocationRequest.setRequestLevel(TencentLocationRequest.REQUEST_LEVEL_NAME);\n\t} else {\n\t\tlocationRequest.setRequestLevel(TencentLocationRequest.REQUEST_LEVEL_GEO);\n\t}\n\t// 是否开启了高精度\n\tif (locationOptions.isHighAccuracy != null && locationOptions.isHighAccuracy == true) {\n\t\tlocationRequest.setAllowGPS(true)\n\t} \n\t/**\n\t * 高度信息，腾讯没有明确的api设置\n\t */\n\tif (locationOptions.altitude != null && locationOptions.altitude == true) {\n\t\tlocationRequest.setAllowGPS(true)\n\t} \n\t\n\tmLocationManager.requestSingleFreshLocation(locationRequest, mLocationListener, Looper.getMainLooper());\n\n}\n","export interface Uni {\n  /**\n   * 获取当前的地理位置、速度\n   *\n   * @tutorial http://uniapp.dcloud.io/api/location/location?id=getlocation\n   */\n  getLocation(options: GetLocationOptions) : void;\n}\n\nexport type GetLocation = (options: GetLocationOptions) => void;\nexport type GetLocationSuccess = {\n  /**\n   * 纬度，浮点数，范围为-90~90，负数表示南纬\n   */\n  latitude: number,\n  /**\n   * 经度，范围为-180~180，负数表示西经\n   */\n  longitude: number,\n  /**\n   * 速度，浮点数，单位m/s\n   */\n  speed: number,\n  /**\n   * 位置的精确度\n   */\n  accuracy: number,\n  /**\n   * 高度，单位 m\n   */\n  altitude: number,\n  /**\n   * 垂直精度，单位 m（Android 无法获取，返回 0）\n   */\n  verticalAccuracy: number,\n  /**\n   * 水平精度，单位 m\n   */\n  horizontalAccuracy: number,\n  /**\n   * 地址信息\n   */\n  address: any | null\n};\ntype GetLocationSuccessCallback = (result: GetLocationSuccess) => void;\ntype GetLocationFailCallback = (result: UniError) => void;\ntype GetLocationComplete = any;\ntype GetLocationCompleteCallback = (result: GetLocationComplete) => void;\nexport type GetLocationOptions = {\n  /**\n   * 默认为 wgs84 返回 gps 坐标，gcj02 返回可用于uni.openLocation的坐标\n   */\n  type?: string | null,\n  /**\n   * 传入 true 会返回高度信息，由于获取高度需要较高精确度，会减慢接口返回速度\n   * @type boolean\n   */\n  altitude?: boolean | null,\n  /**\n   * 传入 true 会解析地址\n   * @type boolean\n   */\n  geocode?: boolean | null,\n  /**\n   * 高精度定位超时时间(ms)，指定时间内返回最高精度，该值3000ms以上高精度定位才有效果\n   */\n  highAccuracyExpireTime?: number | null,\n  /**\n   * 开启高精度定位\n   * @type boolean\n   */\n  isHighAccuracy?: boolean | null,\n  /**\n   * 接口调用成功的回调函数\n   */\n  success?: GetLocationSuccessCallback | null,\n  /**\n   * 接口调用失败的回调函数\n   */\n  fail?: GetLocationFailCallback | null,\n  /**\n   * 接口调用结束的回调函数（调用成功、失败都会执行）\n   */\n  complete?: GetLocationCompleteCallback | null\n};\n"],"names":[],"mappings":"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"}