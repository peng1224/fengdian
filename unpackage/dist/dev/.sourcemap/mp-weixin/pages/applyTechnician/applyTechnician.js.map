{"version":3,"file":"applyTechnician.js","sources":["pages/applyTechnician/applyTechnician.vue","../../../HBuilderX.4.66.2025051912/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvYXBwbHlUZWNobmljaWFuL2FwcGx5VGVjaG5pY2lhbi52dWU"],"sourcesContent":["<template>\n  <view class=\"apply-container\">\n    <view class=\"title\">工人认证申请</view>\n    <view class=\"form-card\">\n      <!-- 真实姓名 -->\n      <view class=\"form-item\">\n        <text class=\"label\">真实姓名</text>\n        <input\n          class=\"input\"\n          v-model=\"formData.realName\"\n          placeholder=\"请输入您的真实姓名\"\n        />\n      </view>\n      <!-- 身份证号 -->\n      <view class=\"form-item\">\n        <text class=\"label\">身份证号</text>\n        <input\n          class=\"input\"\n          v-model=\"formData.idCard\"\n          type=\"idcard\"\n          placeholder=\"请输入您的身份证号\"\n        />\n      </view>\n      <!-- 技能简介 -->\n      <view class=\"form-item\">\n        <text class=\"label\">技能简介</text>\n        <textarea\n          class=\"textarea\"\n          v-model=\"formData.skills\"\n          placeholder=\"简单介绍您的专业技能、服务范围等\"\n        ></textarea>\n      </view>\n      <!-- 上传证件图片 (纯手写实现) -->\n      <view class=\"form-item\">\n        <text class=\"label\">相关证件 (可选)</text>\n        <view class=\"custom-file-picker\">\n          <view class=\"image-grid\">\n            <view v-for=\"(image, index) in imageValue\" :key=\"index\" class=\"image-item\">\n              <image :src=\"image.url\" mode=\"aspectFill\" class=\"uploaded-image\" />\n              <view class=\"delete-btn\" @click=\"removeCertImage(index)\">×</view>\n            </view>\n            <view v-if=\"imageValue.length < 3\" class=\"upload-btn\" @click=\"chooseCertImage\">\n              <text>+</text>\n            </view>\n          </view>\n        </view>\n        <text class=\"tip-text\">用于辅助证明您的专业能力，如资格证书、作品图等。</text>\n      </view>\n\n      <!-- 新增：提现收款信息 -->\n      <view class=\"form-section-title\">提现收款信息</view>\n      <text class=\"section-tip\">请务必填写正确的收款信息，以便平台为您结算服务费用。</text>\n\n      <!-- 微信号 (可选) -->\n      <view class=\"form-item\">\n        <text class=\"label\">微信号 (可选)</text>\n        <input\n          class=\"input\"\n          v-model=\"formData.weChatId\"\n          placeholder=\"请输入您的微信号\"\n        />\n        <text class=\"tip-text\">作为备用联系方式或打款参考。</text>\n      </view>\n\n      <!-- 微信收款码 (必填) -->\n      <view class=\"form-item\">\n        <text class=\"label required-label\">微信收款码</text>\n        <view class=\"custom-file-picker\">\n          <view class=\"image-grid\">\n            <view v-if=\"imageValueQrCode.length > 0\" class=\"image-item\">\n              <image :src=\"imageValueQrCode[0].url\" mode=\"aspectFill\" class=\"uploaded-image\" />\n              <view class=\"delete-btn\" @click=\"removeQrCodeImage(0)\">×</view>\n            </view>\n            <view v-else class=\"upload-btn\" @click=\"chooseQrCodeImage\">\n              <text>+</text>\n            </view>\n          </view>\n        </view>\n        <text class=\"warning-text\">\n          <text class=\"warning-icon\">!</text>\n          请务必上传清晰有效的微信收款码截图。若因收款码错误导致打款失败或流向错误，平台不承担责任。\n        </text>\n      </view>\n\n    </view>\n\n    <button\n      class=\"submit-btn\"\n      @click=\"submitApplication\"\n      :loading=\"isLoading\"\n      :disabled=\"isLoading\"\n    >\n      {{ isLoading ? '提交中...' : '确认提交申请' }}\n    </button>\n  </view>\n</template>\n\n<script setup>\nimport { ref, reactive } from 'vue';\nimport { onShow } from '@dcloudio/uni-app';\n\n// 移除了 uni-file-picker 的引入，因为现在使用自定义实现\n\nconst formData = reactive({\n  realName: '',          // 真实姓名\n  idCard: '',            // 身份证号\n  skills: '',            // 技能简介\n  certificates: [],      // 存储上传后的证件图片 URL 列表\n  weChatId: '',          // 新增：微信号\n  weChatQrCodeUrl: ''    // 新增：微信收款码图片的 URL\n});\n\n// imageValue 和 imageValueQrCode 现在存储 { url: 'temp_path', cloudUrl: 'cloud_path', loading: false } 结构\nconst imageValue = ref([]); // 用于证件图片，最多3张\nconst imageValueQrCode = ref([]); // 新增：用于微信收款码图片，最多1张\nconst isLoading = ref(false);\n\n// 通用的图片选择和上传逻辑\nasync function chooseAndUploadImage(type, limit) {\n  return new Promise((resolve, reject) => {\n    uni.chooseImage({\n      count: limit - (type === 'cert' ? imageValue.value.length : imageValueQrCode.value.length), // 可选图片数量\n      sizeType: ['compressed'], // 压缩图\n      sourceType: ['album', 'camera'], // 从相册选择或拍照\n      success: async (res) => {\n        const tempFilePaths = res.tempFilePaths;\n        const uploadedUrls = [];\n\n        // 更新前端显示为本地临时路径和加载状态\n        const currentImages = type === 'cert' ? imageValue.value : imageValueQrCode.value;\n        const newImages = tempFilePaths.map(path => ({ url: path, cloudUrl: '', loading: true }));\n        if (type === 'cert') {\n          imageValue.value = [...currentImages, ...newImages];\n        } else {\n          imageValueQrCode.value = newImages; // 收款码只允许一张，直接替换\n        }\n\n        for (let i = 0; i < tempFilePaths.length; i++) {\n          const filePath = tempFilePaths[i];\n          try {\n            const uploadRes = await uniCloud.uploadFile({\n              filePath: filePath,\n              cloudPath: `uploads/${Date.now()}_${Math.random().toString(36).substring(2, 15)}.png`, // 随机文件名\n            });\n            uploadedUrls.push(uploadRes.fileID);\n\n            // 更新对应图片的 cloudUrl 和 loading 状态\n            const indexToUpdate = (type === 'cert' ? imageValue.value : imageValueQrCode.value).findIndex(img => img.url === filePath);\n            if (indexToUpdate !== -1) {\n              if (type === 'cert') {\n                imageValue.value[indexToUpdate].cloudUrl = uploadRes.fileID;\n                imageValue.value[indexToUpdate].loading = false;\n              } else {\n                imageValueQrCode.value[indexToUpdate].cloudUrl = uploadRes.fileID;\n                imageValueQrCode.value[indexToUpdate].loading = false;\n              }\n            }\n            console.log(`文件上传成功: ${uploadRes.fileID}`);\n\n          } catch (uploadError) {\n            console.error(`文件上传失败: ${filePath}`, uploadError);\n            uni.showToast({ title: `图片上传失败: ${uploadError.errMsg || '未知错误'}`, icon: 'none' });\n            // 移除失败的图片\n            if (type === 'cert') {\n              imageValue.value = imageValue.value.filter(img => img.url !== filePath);\n            } else {\n              imageValueQrCode.value = imageValueQrCode.value.filter(img => img.url !== filePath);\n            }\n            reject(uploadError); // 任何一个失败都拒绝\n            return;\n          }\n        }\n        resolve(uploadedUrls);\n      },\n      fail: (err) => {\n        console.error('选择图片失败:', err);\n        if (err.errMsg !== 'chooseImage:fail cancel') { // 排除用户取消选择的情况\n          uni.showToast({ title: '选择图片失败', icon: 'none' });\n        }\n        reject(err);\n      }\n    });\n  });\n}\n\n// 选择证件图片\nasync function chooseCertImage() {\n  try {\n    const uploadedFileIds = await chooseAndUploadImage('cert', 3);\n    formData.certificates = imageValue.value.map(img => img.cloudUrl).filter(url => url); // 更新 formData\n  } catch (e) {\n    // 错误已在 chooseAndUploadImage 中处理\n  }\n}\n\n// 移除证件图片\nfunction removeCertImage(index) {\n  imageValue.value.splice(index, 1);\n  formData.certificates = imageValue.value.map(img => img.cloudUrl).filter(url => url);\n}\n\n// 选择微信收款码图片\nasync function chooseQrCodeImage() {\n  try {\n    const uploadedFileIds = await chooseAndUploadImage('qrCode', 1);\n    if (uploadedFileIds.length > 0) {\n      formData.weChatQrCodeUrl = uploadedFileIds[0]; // 更新 formData\n    } else {\n      formData.weChatQrCodeUrl = '';\n    }\n  } catch (e) {\n    // 错误已在 chooseAndUploadImage 中处理\n  }\n}\n\n// 移除微信收款码图片\nfunction removeQrCodeImage(index) {\n  imageValueQrCode.value.splice(index, 1);\n  formData.weChatQrCodeUrl = '';\n}\n\n// 提交申请\nasync function submitApplication() {\n  const userInfo = uni.getStorageSync('userinfo');\n  if (!userInfo || !userInfo._id) {\n    return uni.showToast({ title: '请先登录', icon: 'none' });\n  }\n  \n  // 校验必填项\n  if (!formData.realName || !formData.idCard) {\n    return uni.showToast({\n      title: '真实姓名和身份证号为必填项',\n      icon: 'none'\n    });\n  }\n\n  // 校验微信收款码是否上传\n  if (!formData.weChatQrCodeUrl) {\n    return uni.showToast({\n      title: '请上传微信收款码',\n      icon: 'none'\n    });\n  }\n\n  isLoading.value = true;\n  uni.showLoading({ title: '正在提交...' });\n\n  try {\n    const { result } = await uniCloud.callFunction({\n      name: 'applyForTechnician',\n      data: {\n        uid: userInfo._id,\n        applicationData: formData // 包含所有表单数据，包括新的微信信息\n      }\n    });\n\n    if (result.success) {\n      uni.showToast({ title: '申请已提交！', icon: 'success' });\n      \n      // 更新本地用户状态\n      userInfo.technicianApplicationStatus = 'pending';\n      uni.setStorageSync('userinfo', userInfo);\n      \n      setTimeout(() => {\n        uni.switchTab({ url: '/pages/profile/profile' });\n      }, 1500);\n    } else {\n      throw new Error(result.message || '提交失败');\n    }\n  } catch (error) {\n    uni.showToast({\n      title: error.message || '提交申请时发生错误',\n      icon: 'none'\n    });\n  } finally {\n    isLoading.value = false;\n    uni.hideLoading();\n  }\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.apply-container {\n  padding: 40rpx;\n  background-color: #f5f5f5;\n  min-height: 100vh;\n}\n.title {\n  font-size: 48rpx;\n  font-weight: bold;\n  margin-bottom: 40rpx;\n}\n.form-card {\n  background-color: #fff;\n  border-radius: 20rpx;\n  padding: 20rpx 30rpx;\n  box-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.05);\n}\n.form-item {\n  margin-bottom: 30rpx;\n}\n.form-item .label {\n  display: block;\n  font-size: 30rpx;\n  font-weight: 500;\n  margin-bottom: 15rpx;\n  color: #333;\n}\n.form-item .input {\n  border: 1px solid #ddd;\n  border-radius: 10rpx;\n  padding: 18rpx;\n  font-size: 28rpx;\n}\n.form-item .textarea {\n  width: 100%;\n  height: 200rpx;\n  border: 1px solid #ddd;\n  border-radius: 10rpx;\n  padding: 18rpx;\n  font-size: 28rpx;\n  box-sizing: border-box;\n}\n\n.form-section-title {\n  font-size: 36rpx;\n  font-weight: bold;\n  color: #333;\n  margin-top: 50rpx;\n  margin-bottom: 10rpx;\n  padding-bottom: 10rpx;\n  border-bottom: 1rpx solid #eee;\n}\n\n.section-tip {\n  font-size: 26rpx;\n  color: #666;\n  margin-bottom: 30rpx;\n  display: block;\n}\n\n.tip-text {\n  font-size: 24rpx;\n  color: #999;\n  margin-top: 10rpx;\n  display: block;\n}\n\n.required-label::after {\n  content: '*';\n  color: #ff3b30; /* 红色星号 */\n  margin-left: 8rpx;\n}\n\n.warning-text {\n  font-size: 24rpx;\n  color: #ff3b30; /* 红色警告文字 */\n  margin-top: 10rpx;\n  display: flex;\n  align-items: flex-start;\n  .warning-icon {\n    font-weight: bold;\n    margin-right: 8rpx;\n    font-size: 28rpx; /* 稍微大一点的感叹号 */\n  }\n}\n\n.submit-btn {\n  margin-top: 60rpx;\n  width: 100%;\n  height: 90rpx;\n  background-color: var(--themeColor, #1989fa);\n  color: #fff;\n  border-radius: 45rpx;\n  font-size: 32rpx;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n\n/* Custom File Picker Styles */\n.custom-file-picker {\n  margin-top: 10rpx;\n  .image-grid {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 20rpx;\n  }\n  .image-item {\n    position: relative;\n    width: 160rpx;\n    height: 160rpx;\n    border-radius: 10rpx;\n    overflow: hidden;\n    border: 1rpx solid #eee;\n    .uploaded-image {\n      width: 100%;\n      height: 100%;\n    }\n    .delete-btn {\n      position: absolute;\n      top: 0;\n      right: 0;\n      background-color: rgba(0, 0, 0, 0.5);\n      color: #fff;\n      width: 40rpx;\n      height: 40rpx;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      border-bottom-left-radius: 10rpx;\n      font-size: 28rpx;\n      z-index: 1;\n    }\n  }\n  .upload-btn {\n    width: 160rpx;\n    height: 160rpx;\n    border: 2rpx dashed #ccc;\n    border-radius: 10rpx;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 60rpx;\n    color: #ccc;\n    background-color: #f9f9f9;\n    &:active {\n      border-color: #007aff;\n      color: #007aff;\n    }\n  }\n}\n</style>\n","import MiniProgramPage from 'D:/peng.folder/fengdian-main/蜂点到家/pages/applyTechnician/applyTechnician.vue'\nwx.createPage(MiniProgramPage)"],"names":["reactive","ref","uni","uniCloud"],"mappings":"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"}