{"version":3,"file":"chatList.js","sources":["pages/chatList/chatList.vue","../../../HBuilderX.4.66.2025051912/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY2hhdExpc3QvY2hhdExpc3QudnVl"],"sourcesContent":["<template>\n\t<view class=\"header-emptybox\">\n\t\t<text class=\"profile-title\">消息</text>\n\t</view>\n\t<view class=\"chat-list-page\">\n\t\t<view v-if=\"isLoading\" class=\"skeleton-container\">\n\t\t\t<view v-for=\"i in 3\" :key=\"i\" class=\"skeleton-item\">\n\t\t\t\t<view class=\"skeleton-avatar\"></view>\n\t\t\t\t<view class=\"skeleton-details\">\n\t\t\t\t\t<view class=\"skeleton-line-long\"></view>\n\t\t\t\t\t<view class=\"skeleton-line-short\"></view>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t</view>\n\n\t\t<view class=\"chat-list\" v-else-if=\"chatList.length > 0\">\n\t\t\t<view\n\t\t\t\tv-for=\"item in chatList\"\n\t\t\t\t:key=\"item.sessionId\"\n\t\t\t\tclass=\"chat-item\"\n\t\t\t\t@click=\"goToChatDetail(item)\"\n\t\t\t>\n\t\t\t\t<image\n\t\t\t\t\tclass=\"avatar\"\n\t\t\t\t\t:src=\"getAvatarSrc(item)\"  mode=\"aspectFill\"\n\t\t\t\t\t@error=\"handleAvatarError(item)\"\n\t\t\t\t/>\n\t\t\t\t<view class=\"chat-details\">\n\t\t\t\t\t<view class=\"header\">\n\t\t\t\t\t\t<text class=\"nickname\">{{ item.name }}</text>\n\t\t\t\t\t\t<text class=\"last-time\">{{ formatTime(item.lastTime) }}</text>\n\t\t\t\t\t</view>\n\t\t\t\t\t<view class=\"footer\">\n\t\t\t\t\t\t<text class=\"last-message\">{{ item.lastMessage }}</text>\n\t\t\t\t\t\t<view class=\"badge\" v-if=\"item.unread > 0\">\n\t\t\t\t\t\t\t<text class=\"badge-text\">{{ item.unread > 99 ? '99+' : item.unread }}</text>\n\t\t\t\t\t\t</view>\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t</view>\n\n\t\t<view v-else class=\"empty-state\">\n\t\t\t<image src=\"/static/images/empty-chat.png\" class=\"empty-icon\" mode=\"widthFix\" />\n\t\t\t<text class=\"empty-text\">暂无会话消息</text>\n\t\t\t<text class=\"empty-tip\">去和工人们打招呼吧</text>\n\t\t</view>\n\t</view>\n</template>\n\n\n// pages/chatList/chatList.vue\n// chatList.vue\n<script setup>\r\nimport { onShareAppMessage, onShareTimeline } from '@dcloudio/uni-app'\nimport { ref } from 'vue';\nimport {\n  onLoad,\n  onShow,\n  onHide,\n  onUnload\n} from '@dcloudio/uni-app';\n\nconst myPhoneNumber = ref('');\nconst chatList = ref([]);\nconst isLoading = ref(true);\nconst isFirstLoad = ref(true); // 新增：标记是否首次加载\nconst DEFAULT_AVATAR = '/static/images/avatar-placeholder.png';\n\nlet pollingTimer = null; // 全局轮询定时器\n\n// --- 生命周期钩子 ---\nonLoad(() => {\n  const ui = uni.getStorageSync('userinfo');\n  if (!ui?.phoneNumber) {\n    isLoading.value = false;\n    uni.showToast({ title: '请先登录', icon: 'none' });\n    return;\n  }\n  myPhoneNumber.value = ui.phoneNumber;\n});\n\nonShow(() => {\n  if (!myPhoneNumber.value) return;\n\n  if (isFirstLoad.value) {\n    // 首次加载，显示骨架屏\n    isLoading.value = true;\n    fetchChatList().then(() => {\n      isLoading.value = false;\n      isFirstLoad.value = false; // 加载完成后标记为非首次\n    });\n    fetchTotalUnreadCount();\n  } else {\n    // 轮询更新，不显示骨架屏\n    fetchChatList();\n    fetchTotalUnreadCount();\n  }\n\n  // 30秒轮询一次\n  if (pollingTimer) clearInterval(pollingTimer);\n  pollingTimer = setInterval(() => {\n    fetchChatList();\n    fetchTotalUnreadCount();\n  }, 20000);\n});\n\nonHide(() => {\n  if (pollingTimer) {\n    clearInterval(pollingTimer);\n    pollingTimer = null;\n  }\n});\n\nonUnload(() => {\n  if (pollingTimer) {\n    clearInterval(pollingTimer);\n    pollingTimer = null;\n  }\n});\n\nconst fetchChatList = async () => {\n  if (!myPhoneNumber.value) return;\n\n  try {\n    const res = await uniCloud.callFunction({\n      name: 'get-chat-list',\n      data: { userPhoneNumber: myPhoneNumber.value }\n    });\n    if (res.result.success) {\n      const newData = res.result.data.map(session => ({\n        ...session,\n        unread: session.unreadCount || 0\n      }));\n      // 增量更新 chatList\n      newData.forEach(newItem => {\n        const index = chatList.value.findIndex(item => item.sessionId === newItem.sessionId);\n        if (index !== -1) {\n          // 更新已有项\n          chatList.value[index] = newItem;\n        } else {\n          // 添加新项\n          chatList.value.push(newItem);\n        }\n      });\n      // 删除不存在的项\n      chatList.value = chatList.value.filter(item =>\n        newData.some(newItem => newItem.sessionId === item.sessionId)\n      );\n    }\n  } catch (e) {\n    console.error('获取会话列表失败:', e);\n  }\n};\n\nconst fetchTotalUnreadCount = async () => {\n  try {\n    const res = await uniCloud.callFunction({\n      name: 'get-total-unread-count',\n      data: { userPhoneNumber: myPhoneNumber.value }\n    });\n    if (res.result.success) {\n      const total = res.result.totalUnread || 0;\n      if (total > 0) {\n        uni.setTabBarBadge({\n          index: 2,\n          text: total > 99 ? '99+' : total.toString()\n        });\n      } else {\n        uni.removeTabBarBadge({ index: 2 });\n      }\n    }\n  } catch (e) {\n    console.error('获取总未读数失败:', e);\n  }\n};\n\n// 优化 getAvatarSrc 函数\nconst getAvatarSrc = (item) => {\n    // 优先使用后端返回的头像URL\n    // 如果没有或为空，则使用默认占位符\n    return item.avatar || DEFAULT_AVATAR;\n};\r\n\r\n// handleAvatarError 函数，当头像加载失败时，显示默认占位符\nconst handleAvatarError = (item) => {\n  // 确保 item.avatar 有效，防止循环错误\n  if (item.avatar !== DEFAULT_AVATAR) {\n    item.avatar = DEFAULT_AVATAR; // 将错误的头像URL替换为默认占位符\n  }\n  console.error('头像加载失败:', item.avatar);\n};\n\nconst goToChatDetail = (item) => {\n\tuni.navigateTo({\n\t\turl: `/pages/chatDetail/chatDetail?sessionId=${item.sessionId}&name=${encodeURIComponent(item.name)}`\n\t});\n};\n\nconst formatTime = timestamp => {\n  if (!timestamp) return '';\n  const date = new Date(timestamp);\n  const now = new Date();\n  const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n  const startOfYesterday = new Date(startOfToday.getTime() - 86400000);\n\n  if (date >= startOfToday) {\n    return date.toTimeString().slice(0, 5);\n  } else if (date >= startOfYesterday) {\n    return '昨天';\n  } else {\n    const m = String(date.getMonth() + 1).padStart(2, '0');\n    const d = String(date.getDate()).padStart(2, '0');\n    return `${date.getFullYear()}/${m}/${d}`;\n  }\n};\r\n\r\n\r\nonShareAppMessage(() => {\r\n  return {\r\n    title: '蜂点到家 - 本地靠谱的家政技工平台',\r\n    path: '/pages/index/index'\r\n  }\r\n})\r\n\r\nonShareTimeline(() => {\r\n  return {\r\n    title: '蜂点到家 - 快速预约本地服务'\r\n  }\r\n})\n</script>\n\n<style lang=\"scss\" scoped>\n/* 样式保持不变 */\n.header-emptybox {\n\twidth: 100%;\n\theight: 230rpx;\n\tposition: relative;\n}\n.profile-title {\n\tposition: absolute;\n\tfont-size: 55rpx;\n\tfont-weight: 580;\n\tcolor: #1c1c1e;\n\tfont-family: \"Helvetica Neue\", \"PingFang SC\", \"Helvetica\", \"Arial\", sans-serif;\n\ttop: 130rpx;\n\tleft: 35rpx;\n}\n\n.chat-list-page {\n\tbackground-color: #ffffff;\n\tmin-height: 100vh;\n}\n\n.chat-list {\n\tpadding: 0 30rpx;\n}\n\n.chat-item {\n\tdisplay: flex;\n\talign-items: center;\n\tpadding: 30rpx 0;\n\tborder-bottom: 1rpx solid #f0f0f0;\n\ttransition: background-color 0.2s;\n\t&:last-child {\n\t\tborder-bottom: none;\n\t}\n\t&:active {\n\t\tbackground-color: #f5f5f5;\n\t}\n}\n\n.avatar {\n\twidth: 100rpx;\n\theight: 100rpx;\n\tborder-radius: 50%;\n\tmargin-right: 24rpx;\n\tflex-shrink: 0;\n\tbackground-color: #eee;\n}\n\n.chat-details {\n\tflex: 1;\n\tdisplay: flex;\n\tflex-direction: column;\n\tjustify-content: center;\n\toverflow: hidden;\n}\n\n.header {\n\tdisplay: flex;\n\tjustify-content: space-between;\n\talign-items: center;\n\tmargin-bottom: 8rpx;\n}\n\n.nickname {\n\tfont-size: 32rpx;\n\tcolor: #333;\n\tfont-weight: 500;\n}\n\n.last-time {\n\tfont-size: 24rpx;\n\tcolor: #999;\n\tflex-shrink: 0;\n}\n\n.footer {\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: space-between;\n\tgap: 16rpx;\n}\n\n.last-message {\n\tflex: 1;\n\tfont-size: 28rpx;\n\tcolor: #888;\n\toverflow: hidden;\n\ttext-overflow: ellipsis;\n\twhite-space: nowrap;\n}\n\n.badge {\n\tbackground-color: #fa3534;\n\tborder-radius: 999rpx;\n\tdisplay: inline-flex;\n\talign-items: center;\n\tjustify-content: center;\n\tpadding: 0 12rpx;\n\theight: 36rpx;\n\tmin-width: 36rpx;\n\tflex-shrink: 0;\n\tbox-sizing: border-box;\n\tanimation: pulse 1.5s infinite;\n\tbox-shadow: 0 4rpx 8rpx rgba(250, 53, 52, 0.3);\n\tmargin-bottom: 5rpx;\n}\n\n.badge-text {\n\tfont-size: 24rpx;\n\tcolor: #ffffff;\n\tfont-weight: bold;\n\tline-height: 1;\n}\n\n.empty-state {\n\tdisplay: flex;\n\tflex-direction: column;\n\talign-items: center;\n\tjustify-content: center;\n\tpadding-top: 280rpx;\n\t.empty-icon {\n\t\twidth: 300rpx;\n\t}\n\t.empty-text {\n\t\tfont-size: 30rpx;\n\t\tcolor: #333;\n\t\tmargin-top: 30rpx;\n\t}\n\t.empty-tip {\n\t\tfont-size: 26rpx;\n\t\tcolor: #999;\n\t\tmargin-top: 15rpx;\n\t}\n}\n\n.skeleton-container {\n\tpadding: 0 30rpx;\n}\n.skeleton-item {\n\tdisplay: flex;\n\talign-items: center;\n\tpadding: 40rpx 0;\n\tborder-bottom: 1rpx solid #f0f0f0;\n}\n.skeleton-avatar {\n\twidth: 120rpx;\n\theight: 120rpx;\n\tborder-radius: 50%;\n\tbackground-color: #E0E0E0;\n\tmargin-right: 24rpx;\n\tanimation: skeleton-shimmer 1.5s infinite ease-in-out;\n}\n.skeleton-details {\n\tflex: 1;\n\tdisplay: flex;\n\tflex-direction: column;\n\tjustify-content: space-around;\n\theight: 100rpx;\n}\n.skeleton-line-long {\n\twidth: 80%;\n\theight: 36rpx;\n\tbackground-color: #E0E0E0;\n\tborder-radius: 8rpx;\n\tanimation: skeleton-shimmer 1.5s infinite ease-in-out;\n}\n.skeleton-line-short {\n\twidth: 50%;\n\theight: 28rpx;\n\tbackground-color: #E0E0E0;\n\tborder-radius: 8rpx;\n\tanimation: skeleton-shimmer 1.5s infinite ease-in-out;\n}\n\n@keyframes skeleton-shimmer {\n\t0% {\n\t\topacity: 0.5;\n\t}\n\t50% {\n\t\topacity: 1;\n\t}\n\t100% {\n\t\topacity: 0.5;\n\t}\n}\n</style>","import MiniProgramPage from 'D:/peng.folder/fengdian-main/蜂点到家/pages/chatList/chatList.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","onLoad","uni","onShow","onHide","onUnload","uniCloud","onShareAppMessage","onShareTimeline"],"mappings":"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"}