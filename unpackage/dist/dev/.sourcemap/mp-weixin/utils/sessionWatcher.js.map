{"version":3,"file":"sessionWatcher.js","sources":["utils/sessionWatcher.js"],"sourcesContent":["// utils/sessionWatcher.js\n\nlet sessionWatcher = null\n\n/**\n * 从云函数拉取聊天列表\n * @param {string} phone\n * @returns {Array}\n */\nexport async function fetchChatList(phone) {\n  if (!phone) return []\n  const { result } = await uniCloud.callFunction({\n    name: 'get-chat-list',\n    data: { userPhoneNumber: phone }\n  })\n  return result.success ? result.data : []\n}\n\n/**\n * 计算未读总数并更新系统 TabBar 徽章\n * @param {Array} list\n * @param {string} phone\n */\nexport function updateBadge(list, phone) {\n  const total = list.reduce((sum, s) => sum + (s.unreadCount?.[phone] || 0), 0)\n  if (total > 0) {\n    uni.setTabBarBadge({\n      index: 2,\n      text: total > 99 ? '99+' : total.toString()\n    })\n  } else {\n    uni.removeTabBarBadge({ index: 2 })\n  }\n}\n\n/**\n * 启动对 ChatSession 的实时监听\n * @param {string} phone\n */\nexport function startWatcher(phone) {\n  if (sessionWatcher) {\n    sessionWatcher.close()\n    sessionWatcher = null\n  }\n  if (!phone) return\n\n  const db = uniCloud.database()\n  sessionWatcher = db\n    .collection('ChatSession')\n    .where({ users: phone }) // ✅ 监听数组包含关系\n    .watch(\n      async () => {\n        const list = await fetchChatList(phone)\n        updateBadge(list, phone)\n      },\n      err => {\n        console.error('sessionWatcher error:', err)\n      }\n    )\n}\n\n/**\n * 停止实时监听\n */\nexport function stopWatcher() {\n  if (sessionWatcher) {\n    sessionWatcher.close()\n    sessionWatcher = null\n  }\n}\n"],"names":["uniCloud","uni"],"mappings":";;AAEA,IAAI,iBAAiB;AAOd,eAAe,cAAc,OAAO;AACzC,MAAI,CAAC;AAAO,WAAO,CAAE;AACrB,QAAM,EAAE,OAAM,IAAK,MAAMA,cAAAA,GAAS,aAAa;AAAA,IAC7C,MAAM;AAAA,IACN,MAAM,EAAE,iBAAiB,MAAO;AAAA,EACpC,CAAG;AACD,SAAO,OAAO,UAAU,OAAO,OAAO,CAAE;AAC1C;AAOO,SAAS,YAAY,MAAM,OAAO;AACvC,QAAM,QAAQ,KAAK,OAAO,CAAC,KAAK,MAAC;;AAAK,oBAAO,OAAE,gBAAF,mBAAgB,WAAU;AAAA,KAAI,CAAC;AAC5E,MAAI,QAAQ,GAAG;AACbC,kBAAAA,MAAI,eAAe;AAAA,MACjB,OAAO;AAAA,MACP,MAAM,QAAQ,KAAK,QAAQ,MAAM,SAAU;AAAA,IACjD,CAAK;AAAA,EACL,OAAS;AACLA,kBAAAA,MAAI,kBAAkB,EAAE,OAAO,EAAC,CAAE;AAAA,EACnC;AACH;AAMO,SAAS,aAAa,OAAO;AAClC,MAAI,gBAAgB;AAClB,mBAAe,MAAO;AACtB,qBAAiB;AAAA,EAClB;AACD,MAAI,CAAC;AAAO;AAEZ,QAAM,KAAKD,cAAQ,GAAC,SAAU;AAC9B,mBAAiB,GACd,WAAW,aAAa,EACxB,MAAM,EAAE,OAAO,OAAO,EACtB;AAAA,IACC,YAAY;AACV,YAAM,OAAO,MAAM,cAAc,KAAK;AACtC,kBAAY,MAAM,KAAK;AAAA,IACxB;AAAA,IACD,SAAO;AACLC,oBAAAA,MAAA,MAAA,SAAA,iCAAc,yBAAyB,GAAG;AAAA,IAC3C;AAAA,EACF;AACL;AAKO,SAAS,cAAc;AAC5B,MAAI,gBAAgB;AAClB,mBAAe,MAAO;AACtB,qBAAiB;AAAA,EAClB;AACH;;;;;"}