"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("./common/vendor.js");Math;const o={__name:"App",setup(o){let n=null;const t=o=>{try{o>0?e.index.setTabBarBadge({index:2,text:o>99?"99+":o.toString()}):e.index.removeTabBarBadge({index:2})}catch(n){console.warn("[Global Watcher] set/remove TabBarBadge failed:",n)}},a=()=>{n&&(console.log("[Global Watcher] Stopping existing watcher."),n.close(),n=null),t(0)},r=async o=>{if(o)try{const n=await e.nr.callFunction({name:"get-total-unread-count",data:{userPhoneNumber:o}});if(n.result.success){const e=n.result.totalUnread||0;console.log(`[Global Watcher] Fetched total unread count for ${o}: ${e}`),t(e)}}catch(n){console.error("[Global Watcher] Failed to fetch total unread count:",n)}},l=()=>{a();const o=e.index.getStorageSync("userinfo"),t=null==o?void 0:o.phoneNumber;if(!t)return void console.log("[Global Watcher] No user logged in. Watcher remains stopped.");console.log(`[Global Watcher] Starting new watcher for user: ${t}`);const l=e.nr.database();l.command,n=l.collection("ChatSession").where({users:t}).watch((e=>{console.log("[Global Watcher] Watched data changed!",e.type,e.docChanges),r(t)}),(e=>{console.error("[Global Watcher] Watcher failed:",e)})),r(t)};return e.onLaunch((()=>{console.log("App Launch"),l()})),e.onShow((()=>{console.log("App Show");const o=e.index.getStorageSync("userinfo");(null==o?void 0:o.phoneNumber)&&(n?r(o.phoneNumber):(console.log("[Global Watcher] Watcher was null on App Show, restarting."),l()))})),e.onHide((()=>{console.log("App Hide")})),e.index.$on("user-login",l),e.index.$on("user-logout",a),e.index.$on("refresh-global-badge",(()=>{const o=e.index.getStorageSync("userinfo");(null==o?void 0:o.phoneNumber)&&r(o.phoneNumber)})),(e,o)=>({})}};function n(){e.nr.init({provider:"aliyun",spaceId:"mp-1240ebd5-749c-4abc-b593-fd807f0347fb"}),console.log("【uniCloud Init】全局 uniCloud 初始化完成 (尝试无 Secret)，空间ID:","mp-1240ebd5-749c-4abc-b593-fd807f0347fb");return{app:e.createSSRApp(o)}}n().app.mount("#app"),exports.createApp=n;
