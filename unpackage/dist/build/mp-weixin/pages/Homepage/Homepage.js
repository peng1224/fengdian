"use strict";const e=require("../../common/vendor.js"),t={__name:"Homepage",setup(t){let a=null;const n=require("../../static/js/qqmap-wx-jssdk.js");a=new n({key:"ZOYBZ-S7V6G-OSQQ2-QA54H-2PBHE-CXF46"});const i=e.index.getStorageSync("userinfo")||{};function o(e){return e.phoneNumber&&e.name&&e.avatar}o(i)||e.index.showToast({title:"用户信息不完整",icon:"none"});const s=e.reactive({age:"",serviceArea:"",latitude:null,longitude:null,skills:[],price:"",description:"",categories:[],phoneNumber:i.phoneNumber||""}),l=e.ref([]),c=e.ref([]),u=e.ref([]),r=e.ref([]),d=e.ref([]),v=e.ref(!1),p=e.ref(""),h=e.ref(!1),g=e.ref("");async function m(t){try{const n=await e.nr.callFunction({name:"getHomepage",data:{phoneNumber:t}});n.result.success?(a=n.result.data||{},Object.assign(s,{age:a.age||"",serviceArea:a.serviceArea||"",latitude:a.latitude||null,longitude:a.longitude||null,skills:a.skills||[],price:a.price||"",description:a.description||"",categories:a.categories||[],phoneNumber:a.phoneNumber||s.phoneNumber}),l.value=a.bannerImages||[],c.value=a.media||[],d.value=f(a.categories||[])):e.index.showToast({title:"数据加载失败",icon:"none"})}catch(n){console.error("加载失败:",n),e.index.showToast({title:"加载出错",icon:"none"})}var a}function f(e){return e.map((e=>u.value.find((t=>t._id===e)))).filter(Boolean)}function x(t){const a=t.detail.value,n=u.value[a];let i=[...d.value];if(!i.some((e=>e._id===n._id))&&i.length>=5)return e.index.showToast({title:"最多选择 5 个",icon:"none"});i.some((e=>e._id===n._id))?i=i.filter((e=>e._id!==n._id)):i.push(n),d.value=i,s.categories=i.map((e=>e._id))}function b(){e.index.chooseMedia({count:1,mediaType:["image","video"],sourceType:["album","camera"],success:t=>{const a=t.tempFiles[0],n="video"===a.fileType?"mp4":"jpg",i=`Homepage/media/${Date.now()}-${Math.random().toString().slice(2)}.${n}`;e.nr.uploadFile({filePath:a.tempFilePath,cloudPath:i,success:e=>{c.value.push({src:e.fileID,type:a.fileType||"image"}),y("media",c.value)},fail:t=>e.index.showToast({title:"上传失败",icon:"none"})})}})}function w(){e.index.chooseImage({count:1,success:t=>{const a=t.tempFilePaths[0],n=`Homepage/banners/${Date.now()}-${Math.random().toString().slice(2)}.jpg`;e.nr.uploadFile({filePath:a,cloudPath:n,success:e=>{l.value.push(e.fileID),y("bannerImages",l.value)},fail:t=>e.index.showToast({title:"上传失败",icon:"none"})})}})}async function y(t,a){const n=i.phoneNumber;if(n)try{await e.nr.callFunction({name:"updateHomepage",data:{action:"updateField",phoneNumber:n,field:t,value:a}}),console.log(`${t} 更新成功`)}catch(o){console.error("更新失败:",o),e.index.showToast({title:"更新失败",icon:"none"})}}function N(){e.index.authorize({scope:"scope.userLocation",success:()=>(e.index.showLoading({title:"定位...",mask:!0}),void e.index.getLocation({type:"gcj02",success:t=>{const{latitude:n,longitude:i}=t;s.latitude=n,s.longitude=i,a.reverseGeocoder({location:{latitude:n,longitude:i},success:t=>{e.index.hideLoading();const a=t.result.address_component,n=a.district||"",i=a.town||"",o=a.street||"";let l=n;i?l+=`·${i}`:o&&(l+=`·${o}`),l||(l="未知"),s.serviceArea=l},fail:()=>{e.index.hideLoading(),e.index.showToast({title:"地址解析失败",icon:"none"})}})},fail:()=>{e.index.hideLoading(),e.index.showToast({title:"定位失败",icon:"none"})}}))})}async function T(){if(!o(i))return;e.index.showLoading({title:"保存中...",mask:!0});const t={phoneNumber:s.phoneNumber,accountPhoneNumber:i.phoneNumber,userId:i._id,bannerImages:l.value,media:c.value,age:s.age,serviceArea:s.serviceArea,latitude:s.latitude,longitude:s.longitude,skills:s.skills,price:s.price,description:s.description,categories:s.categories,avatar:i.avatar,name:i.name};try{const a=await e.nr.callFunction({name:"updateHomepage",data:{action:"update",phoneNumber:i.phoneNumber,data:t}});e.index.hideLoading(),a.result.success?e.index.showToast({title:"保存成功",icon:"success"}):e.index.showToast({title:a.result.error||"保存失败",icon:"none"})}catch(a){e.index.hideLoading(),console.error("保存失败:",a),e.index.showToast({title:"网络错误",icon:"none"})}}function k(){v.value=!0,p.value=""}function L(){const e=p.value.trim();e&&(s.skills.push(e),v.value=!1,p.value="")}function _(){v.value=!1,p.value=""}function F(){h.value=!0,g.value=s.age}function A(){/^\d+$/.test(g.value)?(s.age=g.value,h.value=!1):e.index.showToast({title:"请输入有效数字",icon:"none"})}function j(){h.value=!1}return e.onMounted((()=>{m(i.phoneNumber),async function(){try{const t=(await e.nr.callFunction({name:"getNavData"})).result.data||[];u.value=t,r.value=t.map((e=>e.classname)),s.categories.length&&(d.value=f(s.categories))}catch(t){console.error(t),e.index.showToast({title:"分类加载失败",icon:"none"})}}()})),(t,a)=>e.e({a:!s||0===Object.keys(s).length},s&&0!==Object.keys(s).length?e.e({c:e.f(l.value,((t,a,n)=>({a:t,b:e.o((t=>function(t){e.index.previewImage({urls:l.value,current:l.value[t]})}(a)),a),c:e.o((t=>function(t){e.index.showActionSheet({itemList:["删除该图片"],success:()=>{const a=l.value[t];e.nr.deleteFile({fileList:[a],success:e=>{0===e.fileList[0].status&&(l.value.splice(t,1),y("bannerImages",l.value))}})}})}(a)),a),d:a}))),d:0===l.value.length},(l.value.length,{}),{e:e.t(l.value.length?"管理轮播图":"上传轮播图"),f:e.o(w),g:0===d.value.length},(d.value.length,{}),{h:e.f(d.value,((t,a,n)=>({a:e.t(t.classname),b:e.o((e=>function(e){const t=[...d.value];t.splice(e,1),d.value=t,s.categories=t.map((e=>e._id))}(a)),a),c:a}))),i:r.value,j:e.o(x),k:e.unref(i).avatar,l:e.t(e.unref(i).name),m:e.t(s.age?s.age+"岁":"请填写年龄"),n:e.o(F),o:e.t(s.serviceArea||"请选择服务区域"),p:h.value},h.value?{q:g.value,r:e.o((e=>g.value=e.detail.value)),s:e.o(j),t:e.o(A)}:{},{v:e.t(s.serviceArea||"点击选择服务区域"),w:e.o(N),x:s.phoneNumber,y:e.o((e=>s.phoneNumber=e.detail.value)),z:0===s.skills.length},(s.skills.length,{}),{A:e.f(s.skills,((t,a,n)=>({a:e.t(t),b:a,c:e.o((t=>function(t){e.index.showActionSheet({itemList:["删除该项"],success:()=>{s.skills.splice(t,1)}})}(a)),a)}))),B:e.o(k),C:s.price,D:e.o((e=>s.price=e.detail.value)),E:s.description,F:e.o((e=>s.description=e.detail.value)),G:0===c.value.length},(c.value.length,{}),{H:e.f(c.value,((t,a,n)=>e.e({a:"image"===t.type},"image"===t.type?{b:t.src}:{},{c:"video"===t.type},"video"===t.type?{d:t.src}:{},{e:a,f:e.o((t=>function(t){e.index.showActionSheet({itemList:["删除该内容"],success:()=>{const a=c.value[t].src;e.nr.deleteFile({fileList:[a],success:e=>{0===e.fileList[0].status&&(c.value.splice(t,1),y("media",c.value))}})}})}(a)),a)}))),I:e.o(b),J:e.o(T),K:v.value},v.value?{L:p.value,M:e.o((e=>p.value=e.detail.value)),N:e.o(_),O:e.o(L)}:{}):{b:e.f(5,((e,t,a)=>({a:e})))})}},a=e._export_sfc(t,[["__scopeId","data-v-0bd38dc2"]]);wx.createPage(a);
