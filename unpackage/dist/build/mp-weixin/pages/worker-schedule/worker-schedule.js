"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js");if(!Array){(e.resolveComponent("uni-load-more")+e.resolveComponent("uni-icons"))()}Math||((()=>"../../uni_modules/uni-load-more/components/uni-load-more/uni-load-more.js")+(()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js"))();const n={__name:"worker-schedule",setup(n){const o=e.ref([]),a=e.ref([]),s=e.ref(""),i=e.ref(!1),r=e.ref([]),l=e.ref(null);e.onShow((()=>{const t=e.index.getStorageSync("userinfo");if(!t||!t._id)return e.index.showToast({title:"请先登录",icon:"none"}),void e.index.navigateTo({url:"/pages/login/login"});0===o.value.length?(u(),d(o.value[0].dateString)):v(s.value)}));const u=()=>{const e=[],t=new Date,n=["今天","明天","后天"],a=["周日","周一","周二","周三","周四","周五","周六"];for(let o=0;o<5;o++){const s=new Date(t);s.setDate(t.getDate()+o);const i=s.getFullYear(),r=String(s.getMonth()+1).padStart(2,"0"),l=String(s.getDate()).padStart(2,"0");e.push({name:o<3?n[o]:a[s.getDay()],shortDate:`${r}-${l}`,dateString:`${i}-${r}-${l}`})}o.value=e},c=()=>{const e=[];for(let t=9;t<=18;t++)e.push({time:`${String(t).padStart(2,"0")}:00`,isBooked:!1,isPast:!1,isCancelled:!1,appointment:null});return e},d=async e=>{s.value=e,await v(e)},v=async t=>{i.value=!0,a.value=[];try{const n=(e.index.getStorageSync("userinfo")||{})._id;if(!n)throw new Error("无法获取工人ID，请重新登录");const o=await e.nr.callFunction({name:"getAppointmentsForWorker",data:{workerId:n,date:t}});if(!o.result.success)throw new Error(o.result.message||"加载预约失败");r.value=o.result.data,m(t)}catch(n){console.error(n),e.index.showToast({title:n.message,icon:"none"}),a.value=c()}finally{i.value=!1}},m=e=>{const t=new Date,n=t.toISOString().slice(0,10),o=t.getHours();a.value=c().map((t=>{const a=parseInt(t.time.split(":")[0]),s=e<n||e===n&&a<o,i=r.value.find((e=>e.serviceHour===t.time));return{...t,isBooked:!!i,isPast:s,appointment:i,isCancelled:!!i&&"confirmed"!==i.status}}))},p=()=>{l.value=null};return(n,r)=>e.e({a:e.f(o.value,((t,n,o)=>({a:e.t(t.name),b:e.t(t.shortDate),c:n,d:s.value===t.dateString?1:"",e:e.o((e=>d(t.dateString)),n)}))),b:i.value},i.value?{c:e.p({status:"loading"})}:0===a.value.length?{e:t._imports_0$3}:{f:e.f(a.value,((t,n,o)=>e.e({a:e.t(t.time),b:t.isBooked},t.isBooked?{c:e.t(t.isCancelled?"已取消":"已预约"),d:t.isCancelled?1:""}:{},{e:n,f:t.isBooked?1:"",g:t.isPast?1:"",h:t.isCancelled?1:"",i:e.o((e=>(e=>{e.isBooked&&!e.isPast&&(l.value=e.appointment)})(t)),n)})))},{d:0===a.value.length,g:l.value},l.value?e.e({h:e.p({type:"calendar",size:"20",color:"#666"}),i:e.t(l.value.serviceDate),j:e.t(l.value.serviceHour),k:e.p({type:"person",size:"20",color:"#666"}),l:e.t(l.value.userName),m:e.p({type:"phone",size:"20",color:"#666"}),n:e.t(l.value.userPhone),o:e.o((t=>{return n=l.value.userPhone,e.index.makePhoneCall({phoneNumber:n});var n})),p:e.p({type:"chat",size:"20",color:"#666"}),q:e.t(l.value.remark),r:"confirmed"===l.value.status},"confirmed"===l.value.status?{s:e.o((t=>{return n=l.value,void e.index.showModal({title:"取消预约",editable:!0,placeholderText:"请输入取消原因（必填）",success:async t=>{if(t.confirm){const a=t.content;if(!a.trim())return void e.index.showToast({title:"必须填写取消原因",icon:"none"});e.index.showLoading({title:"正在提交..."});try{const t=(e.index.getStorageSync("userinfo")||{}).phoneNumber,o=await e.nr.callFunction({name:"cancelAppointmentByWorker",data:{appointmentId:n._id,workerPhone:t,cancellationReason:a}});if(e.index.hideLoading(),!o.result.success)throw new Error(o.result.message||"取消失败");e.index.showToast({title:"取消成功",icon:"success"}),p(),v(s.value)}catch(o){e.index.hideLoading(),e.index.showToast({title:o.message,icon:"none"})}}}});var n}))}:{},{t:e.o((()=>{})),v:e.o(p)}):{})}},o=e._export_sfc(n,[["__scopeId","data-v-0543344c"]]);wx.createPage(o);
