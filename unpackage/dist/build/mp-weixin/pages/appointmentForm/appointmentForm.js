"use strict";const e=require("../../common/vendor.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const t={__name:"appointmentForm",setup(t){const a=e.ref(""),n=e.ref(""),o=e.ref(""),i=e.ref(e.index.getStorageSync("userinfo")||{}),l=e.ref([]),s=e.ref([]),r=e.ref(""),u=e.ref(""),d=e.ref(!1),c=e.ref({name:"",address:"",latitude:null,longitude:null,detail:""});e.onLoad((t=>{const{userId:o,accountPhoneNumber:i}=t;o?(a.value=o,n.value=i):(e.index.showToast({title:"缺少师傅信息",icon:"error"}),e.index.navigateBack())})),e.onMounted((()=>{g(),l.value.length>0&&h(l.value[0].dateString)})),e.watch(r,(e=>{e&&(u.value="",f(e))}));const v=async()=>{try{(await e.index.getSetting()).authSetting["scope.userLocation"]||await e.index.authorize({scope:"scope.userLocation"});const t=await e.index.chooseLocation({latitude:c.value.latitude||void 0,longitude:c.value.longitude||void 0});let a=t.name,n=t.address;if(!a&&n){const e=n.split(/[-·]/);a=e[0].trim(),n=e.slice(1).join("-").trim()||n}else if(!n&&a)n=a,a=a.split(/[-·]/)[0].trim();else if(!a&&!n)return void e.index.showToast({title:"无法获取地址信息，请重新选择",icon:"none"});c.value.name=a||"未知地点",c.value.address=n||"未知地址",c.value.latitude=t.latitude,c.value.longitude=t.longitude}catch(t){t.errMsg&&t.errMsg.includes("cancel")?console.log("用户取消选择地点"):(console.error("选择地点失败:",t),e.index.showToast({title:"选择地点失败，请检查权限",icon:"none"}))}},g=()=>{const e=[],t=new Date,a=["周日","周一","周二","周三","周四","周五","周六"],n=["今天","明天","后天"];for(let o=0;o<7;o++){const i=new Date(t);i.setDate(t.getDate()+o);const l=i.getFullYear(),s=(i.getMonth()+1).toString().padStart(2,"0"),r=i.getDate().toString().padStart(2,"0");let u=o<3?n[o]:a[i.getDay()];e.push({name:u,shortDate:`${s}-${r}`,dateString:`${l}-${s}-${r}`})}l.value=e},m=()=>{const e=[];for(let t=9;t<=18;t++)e.push({time:`${t.toString().padStart(2,"0")}:00`,isBooked:!1,isPast:!1});return e},h=e=>{r.value=e},f=async t=>{if(a.value){d.value=!0,s.value=[];try{const n=(await e.nr.callFunction({name:"getAppointmentsByWorker",data:{workerId:a.value,date:t}})).result.data||[],o=m(),i=new Date,l=`${i.getFullYear()}-${(i.getMonth()+1).toString().padStart(2,"0")}-${i.getDate().toString().padStart(2,"0")}`,r=i.getHours();s.value=o.map((e=>{const a=parseInt(e.time.split(":")[0]),o=t===l&&a<=r;return{...e,isBooked:n.includes(e.time),isPast:o}}))}catch(n){console.error("获取预约时段失败:",n),e.index.showToast({title:"加载时间失败",icon:"none"}),s.value=m()}finally{d.value=!1}}},p=async()=>{if(!u.value)return e.index.showToast({title:"请选择服务时间",icon:"none"});if(!c.value.name||!c.value.address)return e.index.showToast({title:"请选择服务地点",icon:"none"});if(!c.value.detail.trim())return e.index.showToast({title:"请填写详细地址",icon:"none"});if(!o.value.trim())return e.index.showToast({title:"请填写具体服务需求",icon:"none"});if(!i.value._id)return e.index.showToast({title:"请先登录",icon:"none"});e.index.showLoading({title:"正在提交..."});try{const t=await e.nr.callFunction({name:"createAppointment",data:{workerId:a.value,workerPhone:n.value,userId:i.value._id,userPhone:i.value.phoneNumber,userName:i.value.name||"匿名用户",serviceDate:r.value,serviceHour:u.value,serviceAddress:c.value,remark:o.value}});e.index.hideLoading(),t.result.success?(e.index.showToast({title:"预约成功！",icon:"success"}),setTimeout((()=>e.index.navigateBack()),1500)):(e.index.showToast({title:t.result.message||"预约失败",icon:"none"}),"SLOT_TAKEN"===t.result.code&&f(r.value))}catch(t){e.index.hideLoading(),e.index.showToast({title:"网络错误，请稍后再试",icon:"none"}),console.error("提交预约失败:",t)}};return(t,n)=>e.e({a:e.t(a.value),b:e.f(l.value,((t,a,n)=>({a:e.t(t.name),b:e.t(t.shortDate),c:a,d:e.n({"active-day":r.value===t.dateString}),e:e.o((e=>h(t.dateString)),a)}))),c:d.value},d.value||0===s.value.length?{}:{e:e.f(s.value,((t,a,n)=>({a:e.t(t.time),b:a,c:e.n({"selected-slot":u.value===t.time,"booked-slot":t.isBooked,"past-slot":t.isPast}),d:e.o((a=>(t=>{t.isBooked?e.index.showToast({title:"该时段已被预约",icon:"none"}):t.isPast?e.index.showToast({title:"不能选择过去的时间",icon:"none"}):u.value=t.time})(t)),a)})))},{d:0===s.value.length,f:c.value.name},c.value.name?{g:e.t(c.value.name)}:{},{h:c.value.address},c.value.address?{i:e.t(c.value.address)}:{},{j:!c.value.name},(c.value.name,{}),{k:e.p({type:"location-filled",size:"24",color:"#999"}),l:e.o(v),m:c.value.detail,n:e.o((e=>c.value.detail=e.detail.value)),o:o.value,p:e.o((e=>o.value=e.detail.value)),q:e.o(p),r:!u.value})}},a=e._export_sfc(t,[["__scopeId","data-v-841a6d2f"]]);wx.createPage(a);
