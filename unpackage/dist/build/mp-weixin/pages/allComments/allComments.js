"use strict";const e=require("../../common/vendor.js"),t={__name:"allComments",setup(t){const n=e.ref(""),a=e.ref(null),o=e.ref([]),i=e.reactive({}),l=e.ref(!0),s=e.ref(!1),c=e.ref(!0),u=e.ref(1);e.onLoad((t=>{t.technicianId?(n.value=t.technicianId,d()):(e.index.showToast({title:"参数错误",icon:"none"}),l.value=!1)})),e.onReachBottom((()=>{c.value&&!s.value&&(u.value++,d(!0))}));const d=async(t=!1)=>{t?s.value=!0:l.value=!0;try{const d=await e.nr.callFunction({name:"getCommentsByTechnicianId",data:{technicianId:n.value,page:u.value,pageSize:10}});if(d.result.success){const{commentData:e,total:n,techInfo:l}=d.result;a.value||(a.value=l),e.forEach((e=>{i[e.appointmentId]||(i[e.appointmentId]={showReplies:!1,showInput:!1,content:""})})),o.value=t?[...o.value,...e]:e,c.value=o.value.length<n}else e.index.showToast({title:d.result.message||"加载失败",icon:"none"})}catch(d){console.error("获取评论失败",d),e.index.showToast({title:"网络错误，请重试",icon:"none"})}finally{l.value=!1,s.value=!1}},r=e=>new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});return(t,n)=>e.e({a:a.value},a.value?{b:a.value.avatar,c:e.t(a.value.name)}:{},{d:l.value},(l.value,{}),{e:!l.value&&0===o.value.length},(l.value||o.value.length,{}),{f:e.f(o.value,((t,n,a)=>{var o,l,s,c;return e.e({a:t.avatar,b:e.t(t.name),c:e.t(r(t.createdAt)),d:t.rating},t.rating?{e:e.f(5,((e,n,a)=>({a:e,b:e<=t.rating?1:""})))}:{},{f:e.t(t.comment),g:t.images&&t.images.length>0},t.images&&t.images.length>0?{h:e.f(t.images,((e,t,n)=>({a:t,b:e})))}:{},{i:e.o((n=>(t=>{const n=e.index.getStorageSync("userinfo");n&&n._id?i[t]&&(i[t].showInput=!i[t].showInput):e.index.showToast({title:"请先登录再回复",icon:"none"})})(t.appointmentId)),t.appointmentId),j:t.replies&&t.replies.length>0},t.replies&&t.replies.length>0?{k:e.f(t.replies,((t,n,a)=>({a:t.userAvatar,b:e.t(t.userName),c:e.t(r(t.createdAt)),d:e.t(t.content),e:t.replyId}))),l:null==(o=i[t.appointmentId])?void 0:o.showReplies,m:e.t((null==(l=i[t.appointmentId])?void 0:l.showReplies)?"收起回复":`查看全部 ${t.replies.length} 条回复`),n:e.o((e=>{return n=t.appointmentId,void(i[n]&&(i[n].showReplies=!i[n].showReplies));var n}),t.appointmentId)}:{},{o:null==(s=i[t.appointmentId])?void 0:s.showInput},(null==(c=i[t.appointmentId])?void 0:c.showInput)?{p:i[t.appointmentId].content,q:e.o((e=>i[t.appointmentId].content=e.detail.value),t.appointmentId),r:e.o((n=>(async t=>{const n=i[t].content;if(!n.trim())return void e.index.showToast({title:"回复内容不能为空",icon:"none"});const a=e.index.getStorageSync("userinfo");if(!a||!a._id)return void e.index.showToast({title:"请先登录再回复",icon:"none"});const o={_id:a._id,nickname:a.name||a.nickname||"",avatar:a.avatar||""};e.index.showLoading({title:"正在提交..."});try{const a=await e.nr.callFunction({name:"addCommentReply",data:{homepageId:detail.value._id,commentId:t,content:n.trim(),userInfo:o}});e.index.hideLoading(),a.result.success?(e.index.showToast({title:"回复成功",icon:"success"}),i[t].content="",i[t].showInput=!1,getDetail()):e.index.showToast({title:a.result.message||"回复失败",icon:"none"})}catch(l){e.index.hideLoading(),e.index.showToast({title:"回复失败，请重试",icon:"none"}),console.error("回复提交失败",l)}})(t.appointmentId)),t.appointmentId)}:{},{s:t.appointmentId})})),g:s.value},(s.value,{}),{h:!c.value&&o.value.length>0},(!c.value&&o.value.length,{}))}};wx.createPage(t);
