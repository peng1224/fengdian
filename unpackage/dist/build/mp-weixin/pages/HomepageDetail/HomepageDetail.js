"use strict";const e=require("../../common/vendor.js"),n={__name:"HomepageDetail",setup(n){e.nr.database();const t=e.ref(null),o=e.ref(""),a=e.ref(!0),i=e.ref(""),s=e.reactive({}),l=e.computed((()=>t.value&&t.value.comments?t.value.comments.slice(0,2):[])),r=e=>{const n=new Date(e),t=n.getMonth()+1,o=n.getDate();return`${t.toString().padStart(2,"0")}月${o.toString().padStart(2,"0")}日`};e.onLoad((n=>{n.id?(o.value=n.id,c(),d(n.id)):(e.index.showToast({title:"无法加载详情",icon:"none"}),a.value=!1)}));const c=async()=>{try{const n=await e.nr.callFunction({name:"getHomepageDetail",data:{id:o.value}});if(n.result&&n.result.data){let o=n.result.data;const a=(e.index.getStorageSync("userinfo")||{}).phoneNumber;let l=!1;if(o.likedBy&&Array.isArray(o.likedBy)&&a){const e=(new Date).toDateString();l=o.likedBy.some((n=>n.phoneNumber===a&&new Date(n.likeTime).toDateString()===e))}o.userLiked=l,o.bannerImages&&Array.isArray(o.bannerImages)&&0!==o.bannerImages.length||(o.bannerImages=["/static/images/logo.jpg"]),o.comments&&Array.isArray(o.comments)&&o.comments.sort(((e,n)=>n.createdAt-e.createdAt)),o.comments&&o.comments.forEach((e=>{s[e.appointmentId]={showReplies:!1,showInput:!1,content:""}}));const r=o.phoneNumber||"";i.value=r.replace(/(\d{3})\d{4}(\d{4})/,"$1****$2"),t.value=o}else e.index.showToast({title:"加载失败，无数据返回",icon:"none"})}catch(n){console.error("加载详情失败",n),e.index.showToast({title:"加载失败，请稍后重试",icon:"none"})}finally{a.value=!1}},u=async()=>{const n=e.index.getStorageSync("userinfo");if(!n||!n.phoneNumber)return e.index.showToast({title:"请先登录",icon:"none"});const a=t.value.userLiked,i=t.value.likeCount;t.value.userLiked=!a,t.value.likeCount+=a?-1:1,e.index.vibrateShort();try{const s=await e.nr.callFunction({name:"updateLike",data:{id:o.value,phoneNumber:n.phoneNumber}});s.result.success||(t.value.userLiked=a,t.value.likeCount=i,e.index.showToast({title:s.result.message||"操作失败",icon:"none"}))}catch(s){t.value.userLiked=a,t.value.likeCount=i,e.index.showToast({title:"点赞失败，请检查网络",icon:"none"})}},d=n=>{const t=e.index.getStorageSync("userinfo")||{};e.nr.callFunction({name:"recordHomepageView",data:{id:n,phoneNumber:t.phoneNumber||"匿名用户"}}).then((e=>{console.log("浏览记录成功",e)})).catch((e=>{console.error("记录浏览失败",e)}))},m=()=>{var n;const o=null==(n=t.value)?void 0:n.phoneNumber;if(!o)return e.index.showToast({title:"电话号码未提供",icon:"none"});e.index.showModal({title:"确认拨打",content:`确定拨打 ${i.value} 吗？`,success:n=>{n.confirm&&e.index.makePhoneCall({phoneNumber:o,success:()=>{p()},fail:e=>{console.log("拨打失败",e)}})}})},p=()=>{const n=e.index.getStorageSync("userinfo")||{};e.nr.callFunction({name:"recordUserPhoneCallAction",data:{actionType:"phone_call",targetId:o.value,targetPhoneNumber:t.value.phoneNumber,callerPhoneNumber:n.phoneNumber||"未登录用户"}}).then((()=>{console.log("拨打事件已记录")})).catch((e=>{console.error("记录拨打行为失败",e)}))},h=async()=>{const n=(e.index.getStorageSync("userinfo")||{}).phoneNumber,o=t.value.phoneNumber;if(!n)return e.index.showToast({title:"请先登录",icon:"none"});if(!o)return e.index.showToast({title:"无效的聊天对象",icon:"none"});if(n===o)return e.index.showToast({title:"不能和自己聊天",icon:"none"});e.index.showLoading({title:"正在创建会话..."});try{const t=await e.nr.callFunction({name:"createOrUpdateChatSession",data:{userAPhone:n,userBPhone:o}});e.index.hideLoading(),t.result.success&&t.result.sessionId?e.index.navigateTo({url:`/pages/chatDetail/chatDetail?sessionId=${t.result.sessionId}`}):e.index.showToast({title:t.result.message||"会话创建失败",icon:"none"})}catch(a){e.index.hideLoading(),console.error("ChatSession 创建失败",a),e.index.showToast({title:"会话创建出错，请重试",icon:"none"})}},v=()=>{var n,o;const a=e.index.getStorageSync("userinfo");if(!a||!a._id)return void e.index.showToast({title:"请先登录再预约",icon:"none"});const i=(null==(n=t.value)?void 0:n.userId)||"",s=(null==(o=t.value)?void 0:o.accountPhoneNumber)||"";if(!i||!s)return e.index.showToast({title:"预约信息不完整",icon:"none"});e.index.navigateTo({url:`/pages/appointmentForm/appointmentForm?userId=${i}&accountPhoneNumber=${s}`})},g=()=>{e.index.navigateTo({url:`/pages/allComments/allComments?technicianId=${t.value._id}`})};return(n,o)=>e.e({a:a.value},a.value?{b:e.f(5,((e,n,t)=>({a:e})))}:{},{c:!a.value&&t.value},!a.value&&t.value?e.e({d:e.f(t.value.bannerImages,((e,n,t)=>({a:e,b:n}))),e:t.value.avatar,f:e.t(t.value.name),g:t.value.age},t.value.age?{h:e.t(t.value.age)}:{},{i:e.t(t.value.serviceArea),j:"/static/images/"+(t.value.userLiked?"like.png":"like.no.png"),k:e.t(t.value.likeCount),l:e.o(u),m:e.f(t.value.skills,((n,t,o)=>({a:e.t(n),b:t}))),n:e.t(t.value.price),o:e.t(t.value.description),p:t.value.comments&&t.value.comments.length>0},t.value.comments&&t.value.comments.length>0?{q:e.f(l.value,((n,o,a)=>{var i,l,u,d;return e.e({a:n.avatar,b:e.t(n.name),c:e.t(r(n.createdAt)),d:n.rating},n.rating?{e:e.f(5,((e,t,o)=>({a:e,b:e<=n.rating?1:""})))}:{},{f:e.t(n.comment),g:n.images&&n.images.length>0},n.images&&n.images.length>0?{h:e.f(n.images,((e,n,t)=>({a:n,b:e})))}:{},{i:e.o((t=>(n=>{const t=e.index.getStorageSync("userinfo");t&&t._id?s[n]&&(s[n].showInput=!s[n].showInput):e.index.showToast({title:"请先登录再回复",icon:"none"})})(n.appointmentId)),n.appointmentId),j:n.replies&&n.replies.length>0},n.replies&&n.replies.length>0?{k:e.f(n.replies,((n,t,o)=>({a:n.userAvatar,b:e.t(n.userName),c:e.t(r(n.createdAt)),d:e.t(n.content),e:n.replyId}))),l:null==(i=s[n.appointmentId])?void 0:i.showReplies,m:e.t((null==(l=s[n.appointmentId])?void 0:l.showReplies)?"收起回复":`查看全部 ${n.replies.length} 条回复`),n:e.o((e=>{return t=n.appointmentId,void(s[t]&&(s[t].showReplies=!s[t].showReplies));var t}),n.appointmentId)}:{},{o:null==(u=s[n.appointmentId])?void 0:u.showInput},(null==(d=s[n.appointmentId])?void 0:d.showInput)?{p:s[n.appointmentId].content,q:e.o((e=>s[n.appointmentId].content=e.detail.value),n.appointmentId),r:e.o((o=>(async n=>{const o=s[n].content;if(!o.trim())return void e.index.showToast({title:"回复内容不能为空",icon:"none"});const a=e.index.getStorageSync("userinfo");if(!a||!a._id)return void e.index.showToast({title:"请先登录再回复",icon:"none"});const i={_id:a._id,nickname:a.name||a.nickname||"",avatar:a.avatar||""};e.index.showLoading({title:"正在提交..."});try{const a=await e.nr.callFunction({name:"addCommentReply",data:{homepageId:t.value._id,commentId:n,content:o.trim(),userInfo:i}});e.index.hideLoading(),a.result.success?(e.index.showToast({title:"回复成功",icon:"success"}),s[n].content="",s[n].showInput=!1,c()):e.index.showToast({title:a.result.message||"回复失败",icon:"none"})}catch(l){e.index.hideLoading(),e.index.showToast({title:"回复失败，请重试",icon:"none"}),console.error("回复提交失败",l)}})(n.appointmentId)),n.appointmentId)}:{},{s:n.appointmentId})})),r:e.t(t.value.comments.length),s:e.o(g)}:{},{t:e.o(m),v:e.o(h),w:e.o(v),x:t.value.media&&t.value.media.length>0},t.value.media&&t.value.media.length>0?{y:e.f(t.value.media,((n,t,o)=>e.e({a:"image"===n.type},"image"===n.type?{b:n.src}:{},{c:"video"===n.type},"video"===n.type?{d:n.src}:{},{e:t})))}:{}):{})}};wx.createPage(n);
