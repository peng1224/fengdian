"use strict";const e=require("../../common/vendor.js"),a=require("../../common/assets.js"),t={__name:"chatDetail",setup(t){const o=e.ref(""),n=e.ref(""),s=e.ref([]),i=e.ref(""),l=e.ref(999999),r=e.ref(0),c=e.ref(0),d=e.ref(!1),u=e.ref(!1);let g=null;const h=e=>{if(!e)return"未知时间";const a=new Date(e);if(isNaN(a.getTime()))return"无效时间";const t=String(a.getMonth()+1).padStart(2,"0"),o=String(a.getDate()).padStart(2,"0"),n=String(a.getHours()).padStart(2,"0"),s=String(a.getMinutes()).padStart(2,"0");return`${a.getFullYear()}/${t}/${o} ${n}:${s}`},m=()=>{const a=e.getCurrentInstance();a&&e.index.createSelectorQuery().in(a).select(".input-bar").boundingClientRect((a=>{if(!a)return;const t=e.index.getSystemInfoSync().windowHeight;r.value=t-a.height-c.value,v()})).exec()},v=(a=!1)=>{(l.value>9e4||a)&&e.nextTick$1((()=>{l.value=200*s.value.length}))},p=async()=>{var a;if(!d.value&&!u.value){d.value=!0;try{const t=(null==(a=s.value[0])?void 0:a.timestamp)||Date.now(),n=await e.nr.callFunction({name:"get-history-messages",data:{sessionId:o.value,lastTimestamp:t,pageSize:15}});if(n.result.success&&n.result.data.length>0){const e=await w(n.result.data);s.value=[...e,...s.value],u.value=n.result.data.length<15}else u.value=!0}catch(t){console.error("loadMoreMessages",t)}finally{d.value=!1}}},w=async a=>{const t=a.filter((e=>"image"===e.type&&e.fileUrl.startsWith("cloud://"))).map((e=>e.fileUrl));let o={};if(t.length){(await e.nr.getTempFileURL({fileList:t})).fileList.forEach((e=>{o[e.fileID]=e.tempFileURL}))}return a.map((e=>({...e,avatarUrl:e.avatarUrl||"/static/images/avatar-placeholder.png",fileUrl:"image"===e.type&&o[e.fileUrl]||e.fileUrl})))},y=async a=>{const t=e.index.getStorageSync("userinfo")||{},i={type:a.type,sender:n.value,avatarUrl:t.avatar||"/static/images/avatar-placeholder.png",name:t.name||"用户",sessionId:o.value,timestamp:Date.now(),isRevoked:!1,..."text"===a.type?{message:a.text}:{},..."image"===a.type?{fileUrl:a.fileID}:{},..."location"===a.type?{location:a.location}:{}};try{const a=await e.nr.callFunction({name:"send-chat-message",data:{sessionId:o.value,message:i}});a.result.success?(s.value.push({...i,_id:a.result.messageId||String(Date.now())}),v(!0)):e.index.showToast({title:"发送失败",icon:"none"})}catch(l){console.error("sendMessage error:",l),e.index.showToast({title:"发送异常",icon:"none"})}},f=()=>{i.value.trim()&&(y({type:"text",text:i.value}),i.value="")},x=async()=>{try{const a=(await e.index.chooseImage({count:1})).tempFilePaths[0];e.index.showLoading({title:"上传中..."});const t=await e.nr.uploadFile({filePath:a,cloudPath:`chat-images/${o.value}/${Date.now()}-${1e3*Math.random()|0}`});e.index.hideLoading(),y({type:"image",fileID:t.fileID})}catch(a){e.index.hideLoading()}},S=async()=>{var a,t,o;e.index.showLoading({title:"正在定位..."});try{(await e.index.getSetting()).authSetting["scope.userLocation"]||await e.index.authorize({scope:"scope.userLocation"});const{latitude:n,longitude:s}=await e.index.getLocation({type:"gcj02",isHighAccuracy:!0});let i="";if(i="ZOYBZ-S7V6G-OSQQ2-QA54H-2PBHE-CXF46",!i)throw new Error("地图Key未配置");const l=await e.index.request({url:`https://apis.map.qq.com/ws/geocoder/v1/?location=${n},${s}&key=${i}`});if(200!==l.statusCode||0!==l.data.status)throw console.error("腾讯地图逆地址解析失败",l),new Error(`位置服务异常: ${(null==(a=null==l?void 0:l.data)?void 0:a.message)||"网络请求失败"}`);const r=l.data.result,c={latitude:n,longitude:s,name:(null==(t=r.formatted_addresses)?void 0:t.recommend)||(null==(o=r.address_component)?void 0:o.street_number)||"未知位置",address:r.address||"详细地址未知",thumbUrl:`https://apis.map.qq.com/ws/staticmap/v2/?center=${n},${s}&zoom=16&size=800x400&markers=size:large|color:0x3399FF|label:D|${n},${s}&key=${i}`};y({type:"location",location:c})}catch(n){console.error("sendLocation 失败:",n),e.index.showToast({title:n.message||"获取位置失败，请稍后重试",icon:"none",duration:3e3})}finally{e.index.hideLoading()}},L=async()=>{try{const a=await e.nr.callFunction({name:"clear-unread-count",data:{sessionId:o.value,userPhoneNumber:n.value}});return console.log("clear-unread-count result:",a),a.result.success||console.error("清除未读消息数失败:",a.result.message),a.result.success}catch(a){return console.error("markMessagesAsRead error:",a),!1}};e.index.onKeyboardHeightChange((e=>{c.value=e.height,m()}));return e.onLoad((async a=>{if(console.log("【onLoad】页面加载，options:",a),!a.sessionId)return console.warn("【onLoad】缺少 sessionId，将跳转到首页。"),e.index.switchTab({url:"/pages/index/index"});o.value=a.sessionId,console.log("【onLoad】获取到的 sessionId:",o.value);const t=e.index.getStorageSync("userinfo");if(!t||!t.phoneNumber)return console.warn("【onLoad】用户未登录或phoneNumber缺失。"),e.index.showToast({title:"请先登录",icon:"none"});n.value=t.phoneNumber,console.log("【onLoad】我的手机号 myPhoneNumber:",n.value),await(async()=>{try{const a=await e.nr.callFunction({name:"get-history-messages",data:{sessionId:o.value,lastTimestamp:Date.now(),pageSize:15}});if(a.result.success){const e=await w(a.result.data);s.value=e,u.value=e.length<15,v(!0)}else e.index.showToast({title:"获取消息失败",icon:"none"})}catch(a){console.error("fetchInitialMessages",a)}})(),console.log("【onLoad】初始消息加载完成。"),await L(),console.log("【onLoad】消息标记已读完成。"),console.log("【onLoad】当前环境为小程序，尝试启动消息监听..."),(()=>{if(console.log("【startMessageWatcher】函数被调用。"),g)return void console.log("【startMessageWatcher】messageWatcher 已经存在，不再重复创建。");console.log("【startMessageWatcher】尝试获取 uniCloud 数据库实例...");const a=e.nr.database();console.log("【startMessageWatcher】准备创建 watch 监听器，监听 sessionId:",o.value),g=a.collection("ChatMessages").where({sessionId:o.value}).watch({onChange:async e=>{if(console.log("【watch - onChange】接收到数据变化:",e),"init"===e.type)return void console.log("【watch - onChange】初始化数据，跳过处理。");const a=e.docChanges;console.log("【watch - onChange】变化详情 (docChanges):",a);const t=await w(a.map((e=>e.doc)));console.log("【watch - onChange】处理后的消息:",t),a.forEach(((e,a)=>{const o=t[a];if("add"!==e.dataType||s.value.find((e=>e._id===o._id))||(console.log("【watch - onChange】检测到新消息添加:",o),s.value.push(o),v(!0),L()),"update"===e.dataType){console.log("【watch - onChange】检测到消息更新:",o);const e=s.value.findIndex((e=>e._id===o._id));e>-1?(s.value.splice(e,1,o),console.log("【watch - onChange】消息已更新到列表:",o._id)):console.warn("【watch - onChange】更新消息未在当前列表中找到:",o._id)}})),console.log("【watch - onChange】当前消息列表总数:",s.value.length)},onError:e=>{console.error("【watch - onError】监听发生错误:",e)}}),console.log("【startMessageWatcher】watch 监听器已创建。")})()})),e.onReady((()=>{m()})),e.onShow((()=>{})),e.onHide((()=>{})),e.onUnmounted((()=>{console.log("【onUnmounted】页面即将卸载。"),g&&(g.close(),console.log("【onUnmounted】messageWatcher 已关闭。")),e.index.offKeyboardHeightChange(),console.log("【onUnmounted】键盘高度监听已关闭。")})),(t,o)=>e.e({a:d.value},(d.value,{}),{b:e.f(s.value,((o,i,l)=>e.e({a:o.isSystemMessage},o.isSystemMessage?{b:a._imports_0$2}:{c:o.avatarUrl,d:e.o((e=>t.handleAvatarError(o)),o._id)},{e:"text"===o.type&&!o.isRevoked},"text"!==o.type||o.isRevoked?{}:{f:e.t(o.message)},{g:"image"===o.type&&!o.isRevoked},"image"!==o.type||o.isRevoked?{}:{h:o.fileUrl,i:e.o((a=>(a=>{const t=s.value.filter((e=>"image"===e.type&&!e.isRevoked)).map((e=>e.fileUrl));e.index.previewImage({current:a,urls:t})})(o.fileUrl)),o._id)},{j:"location"===o.type&&!o.isRevoked},"location"!==o.type||o.isRevoked?{}:{k:o.location.thumbUrl,l:e.t(o.location.name||"位置"),m:e.t(o.location.address),n:e.o((a=>{return t=o.location,void e.index.openLocation({...t});var t}),o._id)},{o:o.isRevoked},o.isRevoked?{p:e.t(o.sender===n.value?"你":"对方")}:{},{q:e.t(h(o.timestamp)),r:o.isRevoked?1:"",s:e.o((a=>(async a=>{if(a.sender!==n.value)return void e.index.showToast({title:"只能撤回自己的消息",icon:"none"});Date.now()-a.timestamp>12e4?e.index.showToast({title:"消息发送超过2分钟，无法撤回",icon:"none"}):e.index.showActionSheet({itemList:["撤回"],success:async t=>{if(0===t.tapIndex){e.index.showLoading({title:"正在撤回..."});try{const t=await e.nr.callFunction({name:"revoke-chat-message",data:{messageId:a._id}});t.result.success?(a.isRevoked=!0,e.index.showToast({title:"消息已撤回",icon:"success"})):e.index.showToast({title:t.result.message||"撤回失败",icon:"none"})}catch(o){e.index.showToast({title:"撤回失败，请稍后重试",icon:"none"})}finally{e.index.hideLoading()}}}})})(o)),o._id),t:e.n(o.sender===n.value?"mine":"other"),v:e.n({"system-message":o.isSystemMessage}),w:e.n(o.messageType?o.messageType:""),x:o._id,y:"msg-"+o._id}))),c:r.value+"px",d:l.value,e:e.o(p),f:a._imports_1,g:e.o(x),h:a._imports_2,i:e.o(S),j:e.o(f),k:i.value,l:e.o((e=>i.value=e.detail.value)),m:e.o(f),n:c.value+"px"})}};wx.createPage(t);
