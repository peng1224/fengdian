"use strict";const e=require("../../common/vendor.js"),t={__name:"user-schedule",setup(t){const n=e.ref([]),a=e.ref(!0),o=e.ref(!1),i=e.ref(null),s=e.reactive({rating:5,comment:"",images:[],imageUrls:[],anonymous:!1});async function c(){a.value=!0;const t=e.index.getStorageSync("userinfo");if(!t||!t._id)return e.index.showToast({title:"请先登录",icon:"none"}),void(a.value=!1);try{const o=await e.nr.callFunction({name:"getUserAppointments",data:{userId:t._id}});o.result.success?n.value=o.result.data:console.error("云函数返回错误",o.result.message)}catch(o){console.error("调用云函数失败",o)}finally{a.value=!1}}function r(){o.value=!1}async function l(){try{const t=await e.index.chooseImage({count:3-s.images.length,sizeType:["compressed"],sourceType:["album","camera"]});s.images.push(...t.tempFilePaths)}catch(t){}}function u(e){s.anonymous=e.detail.value.length>0}async function d(){e.index.showLoading({title:"正在提交..."});const t=e.index.getStorageSync("userinfo");let n="",a="/static/images/avatar-placeholder.png";!s.anonymous&&t&&(t.name&&(n=t.name),t.avatar&&(a=t.avatar));try{for(const t of s.images){const n=await e.nr.uploadFile({filePath:t,cloudPath:`review-images/${Date.now()}-${Math.random().toString(36).substring(2)}.jpg`,cloudPathAsRealPath:!0});s.imageUrls.push(n.fileID)}}catch(o){return e.index.hideLoading(),void e.index.showToast({title:"图片上传失败",icon:"none"})}try{const t=await e.nr.callFunction({name:"submitReview",data:{appointmentId:i.value._id,workerPhone:i.value.workerPhone,reviewData:{rating:s.rating,comment:s.comment,images:s.imageUrls,name:n,avatar:a}}});e.index.hideLoading(),t.result.success?(e.index.showToast({title:"评价成功",icon:"success"}),r(),c()):e.index.showToast({title:t.result.message||"提交失败",icon:"none"})}catch(o){e.index.hideLoading(),e.index.showToast({title:"提交失败，请重试",icon:"none"})}}return e.onShow(c),(t,m)=>e.e({a:a.value},a.value||0===n.value.length?{}:{c:e.f(n.value,((t,n,a)=>{return e.e({a:e.t(t.serviceDate),b:e.t(t.serviceHour),c:e.t(t.workerPhone),d:t.remark},t.remark?{e:e.t(t.remark)}:{},{f:e.t((r=t.status,{confirmed:"预约成功",cancelled_by_worker:"师傅已取消",cancelled_by_user:"用户已取消",completed:"已完成"}[r]||r)),g:e.n(`status-${t.status}`),h:t.review&&t.review.comment},t.review&&t.review.comment?{i:e.t(t.review.comment)}:{},{j:"confirmed"===t.status},"confirmed"===t.status?{k:e.o((n=>async function(t){const n=await e.index.showModal({title:"确认取消预约？",editable:!0,placeholderText:"请输入取消原因（必填）",confirmText:"确认取消",cancelText:"点错了"});if(n.confirm){const o=n.content;if(!o||!o.trim())return void e.index.showToast({title:"必须填写取消原因",icon:"none"});e.index.showLoading({title:"正在取消..."});try{const n=await e.nr.callFunction({name:"cancelAppointmentByUser",data:{appointmentId:t,cancellationReason:o}});if(!n.result.success)throw new Error(n.result.message||"取消失败");e.index.showToast({title:"取消成功",icon:"success"}),c()}catch(a){e.index.showToast({title:a.message,icon:"none"})}finally{e.index.hideLoading()}}}(t._id)),t._id),l:e.o((n=>async function(t){if((await e.index.showModal({title:"确认完成服务？",content:"完成后可选择评价"})).confirm){e.index.showLoading({title:"请稍候..."});try{(await e.nr.callFunction({name:"updateAppointmentStatusByuser",data:{appointmentId:t._id,status:"completed"}})).result.success?(e.index.showToast({title:"服务已完成",icon:"success"}),c()):e.index.showToast({title:"操作失败",icon:"none"})}catch(n){e.index.showToast({title:"操作失败",icon:"none"})}finally{e.index.hideLoading()}}}(t)),t._id)}:{},{m:"completed"===t.status&&!t.review},"completed"!==t.status||t.review?{}:{n:e.o((e=>{return n=t,i.value=n,s.rating=5,s.comment="",s.images=[],s.imageUrls=[],s.anonymous=!1,void(o.value=!0);var n}),t._id)},{o:t._id});var r}))},{b:0===n.value.length,d:o.value},o.value?e.e({e:e.o(r),f:e.f(5,((t,n,a)=>({a:t,b:t<=s.rating?1:"",c:e.o((e=>function(e){s.rating=e}(t)),t)}))),g:s.comment,h:e.o((e=>s.comment=e.detail.value)),i:e.f(s.images,((t,n,a)=>({a:t,b:e.o((e=>function(e){s.images.splice(e,1)}(n)),n),c:n}))),j:s.images.length<3},s.images.length<3?{k:e.o(l)}:{},{l:s.anonymous,m:e.o(u),n:e.o(d),o:e.o((()=>{})),p:e.o(r)}):{})}},n=e._export_sfc(t,[["__scopeId","data-v-805ee1e8"]]);wx.createPage(n);
