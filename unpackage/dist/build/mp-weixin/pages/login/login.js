"use strict";const e=require("../../common/vendor.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const o={__name:"login",setup(o){const n=e.ref(!1),i=e.ref(!1),t=e.ref(0);let l=null;const a=e.reactive({phone:"",code:""}),s=e.computed((()=>/^1\d{10}$/.test(a.phone)));function c(e){a.phone=e.detail.value.replace(/\D/g,"")}function r(e){a.code=e.detail.value.replace(/\D/g,"")}async function d(){if(s.value){i.value=!0,t.value=60,l=setInterval((()=>{t.value--,t.value<=0&&(clearInterval(l),i.value=!1)}),1e3);try{const{result:o}=await e.nr.callFunction({name:"sendSmsCode",data:{phone:a.phone}});if(!o.success)throw new Error(o.errorMsg||"验证码发送失败");e.index.showToast({title:"验证码已发送",icon:"none"}),o.code&&console.log("[开发调试] 验证码:",o.code)}catch(o){clearInterval(l),i.value=!1,e.index.showToast({title:o.message||"验证码发送异常",icon:"none"})}}else e.index.showToast({title:"请输入有效手机号",icon:"none"})}async function u(){if(s.value)if(/^\d{4}$/.test(a.code)){e.index.showLoading({title:"登录中..."}),n.value=!0;try{const o=e.index.getPushClientId(),{result:i}=await e.nr.callFunction({name:"loginByPhone",data:{phone:a.phone,code:a.code,pushClientId:o}});console.log("[Login] 登录结果:",i),0===i.code&&i.userInfo?(e.index.setStorageSync("userinfo",i.userInfo),e.index.$emit("user-login"),e.index.showToast({title:"登录成功！",icon:"none"}),function(o){let n="/pages/profile/profile";n="admin"===o?"/pages/admin/ReviewApplications/ReviewApplications":"worker"===o?"/pages/Homepage/Homepage":"/pages/index/index",e.index.reLaunch({url:n,success:()=>console.log(`[Login] 跳转成功: ${n}`),fail:e=>console.error(`[Login] 跳转失败: ${n}`,e)})}(i.userInfo.userType)):e.index.showToast({title:i.errorMsg||"登录失败",icon:"none"})}catch(o){console.error("[Login] 登录异常:",o),e.index.showToast({title:o.message||"登录异常",icon:"none"})}finally{e.index.hideLoading(),n.value=!1}}else e.index.showToast({title:"请输入4位验证码",icon:"none"});else e.index.showToast({title:"请输入有效手机号",icon:"none"})}return(o,l)=>({a:e.p({type:"left",size:"22",color:"#1c1c1e"}),b:e.p({type:"phone-filled",size:"22",color:"#8a8a8e"}),c:e.o([e=>a.phone=e.detail.value,c]),d:a.phone,e:e.p({type:"locked-filled",size:"22",color:"#8a8a8e"}),f:e.o([e=>a.code=e.detail.value,r]),g:a.code,h:e.t(i.value?`${t.value}s`:"获取验证码"),i:e.o(d),j:i.value||!s.value,k:n.value,l:e.o(u)})}};wx.createPage(o);
